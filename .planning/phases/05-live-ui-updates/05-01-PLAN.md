---
phase: 05-live-ui-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nodes/batch_saver.py
  - nodes/progress_formatter.py
  - nodes/batch_loader.py
  - tests/test_batch_saver.py
  - tests/test_progress_formatter.py
  - tests/test_batch_loader.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BatchImageSaver broadcasts 'executed' event after saving each image"
    - "BatchProgressFormatter broadcasts progress text for each iteration"
    - "BatchImageLoader broadcasts INDEX and TOTAL_COUNT for each iteration"
    - "Frontend receives UI updates during batch iterations (not just first)"
    - "Broadcast messages include node unique_id for frontend routing"
    - "Existing tests pass, new broadcast tests cover the feature"
  artifacts:
    - path: "nodes/batch_saver.py"
      provides: "BatchImageSaver with HIDDEN inputs and send_sync broadcast"
      contains: "send_sync"
    - path: "nodes/progress_formatter.py"
      provides: "BatchProgressFormatter with HIDDEN inputs and send_sync broadcast"
      contains: "send_sync"
    - path: "nodes/batch_loader.py"
      provides: "BatchImageLoader with send_sync broadcast for INDEX/TOTAL_COUNT"
      contains: "send_sync"
    - path: "tests/test_batch_saver.py"
      provides: "Tests for broadcast behavior"
      contains: "test_broadcast"
    - path: "tests/test_progress_formatter.py"
      provides: "Tests for broadcast behavior"
      contains: "test_broadcast"
    - path: "tests/test_batch_loader.py"
      provides: "Tests for broadcast behavior"
      contains: "test_broadcast"
  key_links:
    - from: "nodes/batch_saver.py"
      to: "PromptServer.instance.send_sync"
      via: "import from server"
      pattern: "send_sync.*sid=None"
    - from: "nodes/progress_formatter.py"
      to: "PromptServer.instance.send_sync"
      via: "import from server"
      pattern: "send_sync.*sid=None"
    - from: "nodes/batch_loader.py"
      to: "PromptServer.instance.send_sync"
      via: "import from server"
      pattern: "send_sync.*sid=None"
---

<objective>
Add live UI update broadcasts to BatchImageSaver, BatchProgressFormatter, and BatchImageLoader nodes so the frontend receives updates during batch processing iterations.

Purpose: Fix the gap where frontend only shows first iteration's results because subsequent queue submissions use different client_ids. By broadcasting with `sid=None`, all connected clients receive updates.

Output: Modified nodes that call `PromptServer.instance.send_sync()` with `sid=None` after producing output, plus tests verifying the broadcast behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-live-ui-updates/05-RESEARCH.md
@nodes/batch_saver.py
@nodes/progress_formatter.py
@nodes/batch_loader.py
@tests/test_batch_saver.py
@tests/test_progress_formatter.py
@tests/test_batch_loader.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add broadcast to BatchImageSaver</name>
  <files>nodes/batch_saver.py, tests/test_batch_saver.py</files>
  <action>
Modify BatchImageSaver to broadcast UI updates after saving:

1. Add PromptServer import with guard (pattern from research):
```python
try:
    from server import PromptServer
    HAS_SERVER = True
except ImportError:
    PromptServer = None
    HAS_SERVER = False
```

2. Add HIDDEN inputs to INPUT_TYPES:
```python
"hidden": {
    "unique_id": "UNIQUE_ID",
}
```

3. Update save_image method signature to accept unique_id=None

4. After the existing return dict is built but BEFORE returning, add broadcast:
```python
# Broadcast UI update to ALL connected clients (fixes batch iteration UI updates)
if HAS_SERVER and PromptServer is not None and PromptServer.instance is not None and unique_id is not None:
    PromptServer.instance.send_sync(
        "executed",
        {
            "node": unique_id,
            "output": result["ui"],
        },
        sid=None  # Broadcast to ALL clients
    )
```

5. Add test in test_batch_saver.py:
- Test class `TestBroadcastBehavior`
- Test `test_broadcasts_executed_event_when_server_available`: Mock PromptServer.instance.send_sync, call save_image with unique_id="123", verify send_sync called with correct args including sid=None
- Test `test_no_broadcast_without_unique_id`: Verify no broadcast when unique_id is None
- Test `test_no_crash_without_server`: Verify no crash when HAS_SERVER is False (default test environment)
- Test `test_hidden_inputs_declared`: Verify INPUT_TYPES includes hidden.unique_id
  </action>
  <verify>
1. `python -m pytest tests/test_batch_saver.py -v` - all tests pass
2. Check nodes/batch_saver.py contains `send_sync` and `sid=None`
3. Check INPUT_TYPES includes hidden with unique_id
  </verify>
  <done>
- BatchImageSaver has HIDDEN unique_id input
- BatchImageSaver calls send_sync("executed", ..., sid=None) after saving
- 4+ new tests pass covering broadcast behavior
- All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add broadcast to BatchProgressFormatter</name>
  <files>nodes/progress_formatter.py, tests/test_progress_formatter.py</files>
  <action>
Modify BatchProgressFormatter to broadcast progress text updates:

1. Add PromptServer import with guard (same pattern as Task 1):
```python
try:
    from server import PromptServer
    HAS_SERVER = True
except ImportError:
    PromptServer = None
    HAS_SERVER = False
```

2. Add HIDDEN inputs to INPUT_TYPES:
```python
"hidden": {
    "unique_id": "UNIQUE_ID",
}
```

3. Update format_progress method signature to accept unique_id=None

4. Change OUTPUT_NODE to True (required for UI updates to display):
```python
OUTPUT_NODE = True
```

5. Change return format to include both "ui" and "result" (standard OUTPUT_NODE pattern):
```python
# Broadcast progress update to ALL connected clients
if HAS_SERVER and PromptServer is not None and PromptServer.instance is not None and unique_id is not None:
    PromptServer.instance.send_sync(
        "executed",
        {
            "node": unique_id,
            "output": {"text": [progress_text]},
        },
        sid=None  # Broadcast to ALL clients
    )

return {"ui": {"text": [progress_text]}, "result": (progress_text,)}
```

6. Add tests in test_progress_formatter.py:
- Test class `TestBroadcastBehavior`
- Test `test_broadcasts_executed_event_when_server_available`: Mock PromptServer, verify send_sync called
- Test `test_no_broadcast_without_unique_id`: Verify no broadcast when unique_id is None
- Test `test_hidden_inputs_declared`: Verify INPUT_TYPES includes hidden.unique_id
- Test `test_output_node_is_true`: Verify OUTPUT_NODE is True
- Update existing return value tests if format changed (now returns dict with ui and result)
  </action>
  <verify>
1. `python -m pytest tests/test_progress_formatter.py -v` - all tests pass
2. Check nodes/progress_formatter.py contains `send_sync` and `sid=None`
3. Check OUTPUT_NODE is True
4. Check INPUT_TYPES includes hidden with unique_id
  </verify>
  <done>
- BatchProgressFormatter has HIDDEN unique_id input
- BatchProgressFormatter has OUTPUT_NODE = True
- BatchProgressFormatter calls send_sync("executed", ..., sid=None)
- BatchProgressFormatter returns dict with "ui" and "result" keys
- 4+ new tests pass covering broadcast behavior
- All existing tests updated and pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add broadcast to BatchImageLoader</name>
  <files>nodes/batch_loader.py, tests/test_batch_loader.py</files>
  <action>
Modify BatchImageLoader to broadcast INDEX and TOTAL_COUNT updates:

1. Add PromptServer import with guard (same pattern as Tasks 1-2):
```python
try:
    from server import PromptServer
    HAS_SERVER = True
except ImportError:
    PromptServer = None
    HAS_SERVER = False
```

2. BatchImageLoader already has HIDDEN unique_id in INPUT_TYPES - verify it exists

3. In _load_with_error_handling method, AFTER successful image load but BEFORE returning, add broadcast:
```python
# Broadcast INDEX/TOTAL_COUNT update to ALL connected clients
if HAS_SERVER and PromptServer is not None and PromptServer.instance is not None and unique_id is not None:
    PromptServer.instance.send_sync(
        "executed",
        {
            "node": unique_id,
            "output": {
                "INDEX": [current_index],
                "TOTAL_COUNT": [total_count],
                "FILENAME": [filename],
                "STATUS": [status],
            },
        },
        sid=None  # Broadcast to ALL clients
    )
```

Note: Place this broadcast call right before the final return statement in _load_with_error_handling. The unique_id parameter is already being passed through from load_image.

4. Add tests in test_batch_loader.py:
- Test class `TestBroadcastBehavior`
- Test `test_broadcasts_executed_event_when_server_available`: Mock PromptServer.instance.send_sync, call load_image with unique_id="123", verify send_sync called with INDEX and TOTAL_COUNT in output
- Test `test_no_broadcast_without_unique_id`: Verify no broadcast when unique_id is None (default)
- Test `test_no_crash_without_server`: Verify no crash when HAS_SERVER is False (test environment default)
- Test `test_broadcast_includes_index_and_total`: Verify broadcast output dict contains INDEX, TOTAL_COUNT, FILENAME, STATUS keys
  </action>
  <verify>
1. `python -m pytest tests/test_batch_loader.py -v` - all tests pass
2. Check nodes/batch_loader.py contains `send_sync` and `sid=None`
3. Check broadcast output includes INDEX and TOTAL_COUNT
  </verify>
  <done>
- BatchImageLoader calls send_sync("executed", ..., sid=None) after loading
- Broadcast includes INDEX, TOTAL_COUNT, FILENAME, STATUS outputs
- 4+ new tests pass covering broadcast behavior
- All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify full test suite and PreviewImage integration</name>
  <files>nodes/batch_saver.py, nodes/progress_formatter.py, nodes/batch_loader.py</files>
  <action>
Run full test suite and verify no regressions:

1. Run all tests: `python -m pytest tests/ -v`

2. Verify node registration still works by checking __init__.py exports

3. Review all three modified files for:
   - Import guard pattern is identical (HAS_SERVER check)
   - send_sync call pattern is identical (sid=None is explicit)
   - No debug print statements left in (remove any added during development)
   - Method signatures have unique_id with default None

4. If any tests fail, fix the issues before completing

5. Clean up any excessive debug logging from batch_loader.py (the existing [BatchImageLoader] prints are verbose - leave them for now but don't add more)

6. **PreviewImage verification note**: The research (05-RESEARCH.md lines 272-276) flags uncertainty about whether PreviewImage nodes update when BatchImageSaver broadcasts. This is a KNOWN LIMITATION to document:
   - BatchImageSaver broadcasts will update its OWN widget display
   - PreviewImage nodes are core ComfyUI nodes that may not respond to our broadcast
   - If PreviewImage doesn't update, this is expected behavior - users should connect to BatchImageSaver's output widget instead
   - Document this in the SUMMARY.md as a known limitation
  </action>
  <verify>
1. `python -m pytest tests/ -v` - ALL tests pass (expect 35+ tests)
2. No import errors when running tests
3. All three nodes have consistent broadcast patterns
4. `grep -n "send_sync" nodes/*.py` shows 3 matches (one per node)
5. `grep -n "sid=None" nodes/*.py` shows 3 matches
  </verify>
  <done>
- Full test suite passes with no failures
- All three nodes have consistent, working broadcast implementation
- No regressions in existing functionality
- PreviewImage limitation documented (if observed)
  </done>
</task>

</tasks>

<verification>
## Phase Verification

1. **Code inspection:**
   - `grep -n "send_sync" nodes/batch_saver.py` shows broadcast call
   - `grep -n "send_sync" nodes/progress_formatter.py` shows broadcast call
   - `grep -n "send_sync" nodes/batch_loader.py` shows broadcast call
   - `grep -n "sid=None" nodes/*.py` shows 3 matches (one per node)

2. **Test coverage:**
   - `python -m pytest tests/test_batch_saver.py -v` - includes broadcast tests
   - `python -m pytest tests/test_progress_formatter.py -v` - includes broadcast tests
   - `python -m pytest tests/test_batch_loader.py -v` - includes broadcast tests
   - `python -m pytest tests/ -v` - full suite passes

3. **Pattern verification:**
   - All three nodes have identical import guard pattern
   - All three nodes have HIDDEN unique_id input
   - All three nodes call send_sync with sid=None after producing output
</verification>

<success_criteria>
1. INDEX, TOTAL_COUNT outputs update visually for each batch iteration (via BatchImageLoader broadcast)
2. BatchImageSaver broadcasts "executed" event with saved image info after each save
3. BatchProgressFormatter broadcasts "executed" event with progress text for each iteration
4. Preview nodes show current image (known limitation: only BatchImageSaver widget guaranteed to update; PreviewImage behavior documented)
5. All broadcasts use sid=None for client-agnostic delivery
6. All existing tests pass (no regressions)
7. New tests verify broadcast behavior with mocked PromptServer
8. Nodes work without PromptServer (graceful degradation for testing)
</success_criteria>

<output>
After completion, create `.planning/phases/05-live-ui-updates/05-01-SUMMARY.md`
</output>
