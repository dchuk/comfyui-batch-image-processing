---
phase: 05-live-ui-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nodes/batch_saver.py
  - nodes/progress_formatter.py
  - tests/test_batch_saver.py
  - tests/test_progress_formatter.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "BatchImageSaver broadcasts 'executed' event after saving each image"
    - "BatchProgressFormatter broadcasts progress text for each iteration"
    - "Frontend receives UI updates during batch iterations (not just first)"
    - "Broadcast messages include node unique_id for frontend routing"
    - "Existing tests pass, new broadcast tests cover the feature"
  artifacts:
    - path: "nodes/batch_saver.py"
      provides: "BatchImageSaver with HIDDEN inputs and send_sync broadcast"
      contains: "send_sync"
    - path: "nodes/progress_formatter.py"
      provides: "BatchProgressFormatter with HIDDEN inputs and send_sync broadcast"
      contains: "send_sync"
    - path: "tests/test_batch_saver.py"
      provides: "Tests for broadcast behavior"
      contains: "test_broadcast"
    - path: "tests/test_progress_formatter.py"
      provides: "Tests for broadcast behavior"
      contains: "test_broadcast"
  key_links:
    - from: "nodes/batch_saver.py"
      to: "PromptServer.instance.send_sync"
      via: "import from server"
      pattern: "send_sync.*sid=None"
    - from: "nodes/progress_formatter.py"
      to: "PromptServer.instance.send_sync"
      via: "import from server"
      pattern: "send_sync.*sid=None"
---

<objective>
Add live UI update broadcasts to BatchImageSaver and BatchProgressFormatter nodes so the frontend receives updates during batch processing iterations.

Purpose: Fix the gap where frontend only shows first iteration's results because subsequent queue submissions use different client_ids. By broadcasting with `sid=None`, all connected clients receive updates.

Output: Modified nodes that call `PromptServer.instance.send_sync()` with `sid=None` after producing output, plus tests verifying the broadcast behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-live-ui-updates/05-RESEARCH.md
@nodes/batch_saver.py
@nodes/progress_formatter.py
@tests/test_batch_saver.py
@tests/test_progress_formatter.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add broadcast to BatchImageSaver</name>
  <files>nodes/batch_saver.py, tests/test_batch_saver.py</files>
  <action>
Modify BatchImageSaver to broadcast UI updates after saving:

1. Add PromptServer import with guard (pattern from research):
```python
try:
    from server import PromptServer
    HAS_SERVER = True
except ImportError:
    PromptServer = None
    HAS_SERVER = False
```

2. Add HIDDEN inputs to INPUT_TYPES:
```python
"hidden": {
    "unique_id": "UNIQUE_ID",
}
```

3. Update save_image method signature to accept unique_id=None

4. After the existing return dict is built but BEFORE returning, add broadcast:
```python
# Broadcast UI update to ALL connected clients (fixes batch iteration UI updates)
if HAS_SERVER and PromptServer is not None and PromptServer.instance is not None and unique_id is not None:
    PromptServer.instance.send_sync(
        "executed",
        {
            "node": unique_id,
            "output": result["ui"],
        },
        sid=None  # Broadcast to ALL clients
    )
```

5. Add test in test_batch_saver.py:
- Test class `TestBroadcastBehavior`
- Test `test_broadcasts_executed_event_when_server_available`: Mock PromptServer.instance.send_sync, call save_image with unique_id="123", verify send_sync called with correct args including sid=None
- Test `test_no_broadcast_without_unique_id`: Verify no broadcast when unique_id is None
- Test `test_no_crash_without_server`: Verify no crash when HAS_SERVER is False (default test environment)
- Test `test_hidden_inputs_declared`: Verify INPUT_TYPES includes hidden.unique_id
  </action>
  <verify>
1. `python -m pytest tests/test_batch_saver.py -v` - all tests pass
2. Check nodes/batch_saver.py contains `send_sync` and `sid=None`
3. Check INPUT_TYPES includes hidden with unique_id
  </verify>
  <done>
- BatchImageSaver has HIDDEN unique_id input
- BatchImageSaver calls send_sync("executed", ..., sid=None) after saving
- 4+ new tests pass covering broadcast behavior
- All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add broadcast to BatchProgressFormatter</name>
  <files>nodes/progress_formatter.py, tests/test_progress_formatter.py</files>
  <action>
Modify BatchProgressFormatter to broadcast progress text updates:

1. Add PromptServer import with guard (same pattern as Task 1):
```python
try:
    from server import PromptServer
    HAS_SERVER = True
except ImportError:
    PromptServer = None
    HAS_SERVER = False
```

2. Add HIDDEN inputs to INPUT_TYPES:
```python
"hidden": {
    "unique_id": "UNIQUE_ID",
}
```

3. Update format_progress method signature to accept unique_id=None

4. Change OUTPUT_NODE to True (required for UI updates to display):
```python
OUTPUT_NODE = True
```

5. Change return format to include both "ui" and "result" (standard OUTPUT_NODE pattern):
```python
# Broadcast progress update to ALL connected clients
if HAS_SERVER and PromptServer is not None and PromptServer.instance is not None and unique_id is not None:
    PromptServer.instance.send_sync(
        "executed",
        {
            "node": unique_id,
            "output": {"text": [progress_text]},
        },
        sid=None  # Broadcast to ALL clients
    )

return {"ui": {"text": [progress_text]}, "result": (progress_text,)}
```

6. Add tests in test_progress_formatter.py:
- Test class `TestBroadcastBehavior`
- Test `test_broadcasts_executed_event_when_server_available`: Mock PromptServer, verify send_sync called
- Test `test_no_broadcast_without_unique_id`: Verify no broadcast when unique_id is None
- Test `test_hidden_inputs_declared`: Verify INPUT_TYPES includes hidden.unique_id
- Test `test_output_node_is_true`: Verify OUTPUT_NODE is True
- Update existing return value tests if format changed (now returns dict with ui and result)
  </action>
  <verify>
1. `python -m pytest tests/test_progress_formatter.py -v` - all tests pass
2. Check nodes/progress_formatter.py contains `send_sync` and `sid=None`
3. Check OUTPUT_NODE is True
4. Check INPUT_TYPES includes hidden with unique_id
  </verify>
  <done>
- BatchProgressFormatter has HIDDEN unique_id input
- BatchProgressFormatter has OUTPUT_NODE = True
- BatchProgressFormatter calls send_sync("executed", ..., sid=None)
- BatchProgressFormatter returns dict with "ui" and "result" keys
- 4+ new tests pass covering broadcast behavior
- All existing tests updated and pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and integration</name>
  <files>nodes/batch_saver.py, nodes/progress_formatter.py</files>
  <action>
Run full test suite and verify no regressions:

1. Run all tests: `python -m pytest tests/ -v`

2. Verify node registration still works by checking __init__.py exports

3. Review both modified files for:
   - Import guard pattern is identical (HAS_SERVER check)
   - send_sync call pattern is identical (sid=None is explicit)
   - No debug print statements left in (remove any added during development)
   - Method signatures have unique_id with default None

4. If any tests fail, fix the issues before completing

5. Clean up any excessive debug logging from batch_saver.py (the existing [BatchImageSaver] prints are verbose - leave them for now but don't add more)
  </action>
  <verify>
1. `python -m pytest tests/ -v` - ALL tests pass (expect 30+ tests)
2. No import errors when running tests
3. Both nodes have consistent broadcast patterns
  </verify>
  <done>
- Full test suite passes with no failures
- Both nodes have consistent, working broadcast implementation
- No regressions in existing functionality
  </done>
</task>

</tasks>

<verification>
## Phase Verification

1. **Code inspection:**
   - `grep -n "send_sync" nodes/batch_saver.py` shows broadcast call
   - `grep -n "send_sync" nodes/progress_formatter.py` shows broadcast call
   - `grep -n "sid=None" nodes/*.py` shows 2 matches (one per node)

2. **Test coverage:**
   - `python -m pytest tests/test_batch_saver.py -v` - includes broadcast tests
   - `python -m pytest tests/test_progress_formatter.py -v` - includes broadcast tests
   - `python -m pytest tests/ -v` - full suite passes

3. **Pattern verification:**
   - Both nodes have identical import guard pattern
   - Both nodes have HIDDEN unique_id input
   - Both nodes call send_sync with sid=None after producing output
</verification>

<success_criteria>
1. BatchImageSaver broadcasts "executed" event with saved image info after each save
2. BatchProgressFormatter broadcasts "executed" event with progress text for each iteration
3. Both broadcasts use sid=None for client-agnostic delivery
4. All existing tests pass (no regressions)
5. New tests verify broadcast behavior with mocked PromptServer
6. Nodes work without PromptServer (graceful degradation for testing)
</success_criteria>

<output>
After completion, create `.planning/phases/05-live-ui-updates/05-01-SUMMARY.md`
</output>
