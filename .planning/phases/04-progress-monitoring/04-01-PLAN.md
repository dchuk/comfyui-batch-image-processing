---
phase: 04-progress-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nodes/batch_saver.py
  - nodes/progress_formatter.py
autonomous: true
must_haves:
  truths:
    - "BatchImageSaver outputs the saved image for downstream wiring"
    - "BatchImageSaver outputs the saved filename and path"
    - "BatchProgressFormatter formats index and total as human-readable string"
  artifacts:
    - path: "nodes/batch_saver.py"
      provides: "Extended save node with passthrough outputs"
      contains: "RETURN_TYPES"
    - path: "nodes/progress_formatter.py"
      provides: "Progress text formatter node"
      exports: ["BatchProgressFormatter"]
  key_links:
    - from: "nodes/batch_saver.py"
      to: "downstream PreviewImage"
      via: "OUTPUT_IMAGE return value"
      pattern: "result.*image"
---

<objective>
Extend BatchImageSaver with passthrough outputs and create BatchProgressFormatter node.

Purpose: Enable progress visibility by (1) letting BatchImageSaver pass the image through for downstream preview wiring, and (2) providing a helper node to format progress as "X of Y (Z%)".

Output: Modified batch_saver.py with new outputs, new progress_formatter.py with BatchProgressFormatter class.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-progress-monitoring/04-CONTEXT.md
@.planning/phases/04-progress-monitoring/04-RESEARCH.md
@nodes/batch_saver.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BatchImageSaver with passthrough outputs</name>
  <files>nodes/batch_saver.py</files>
  <action>
Modify BatchImageSaver class to add outputs for downstream wiring:

1. Change class attributes:
   - `RETURN_TYPES = ()` -> `RETURN_TYPES = ("IMAGE", "STRING", "STRING")`
   - Add `RETURN_NAMES = ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")`
   - Keep `OUTPUT_NODE = True` (still produces UI preview)

2. Modify `save_image()` return statement:
   - Currently returns: `{"ui": {"images": [...]}}`
   - Change to return: `{"ui": {"images": [...]}, "result": (image, saved_filename, saved_path)}`
   - `image` is the input tensor (passthrough, no copy)
   - `saved_filename` is `os.path.basename(final_path)` (just the filename)
   - `saved_path` is `final_path` (full path)

3. Handle skip mode case:
   - When `should_save` is False (skip mode), return empty result tuple
   - Return: `{"ui": {"images": []}, "result": (image, "", "")}`

Note: The image passthrough is efficient - just returns the same tensor reference, no re-encoding.
  </action>
  <verify>
    - `grep -q "RETURN_TYPES = " nodes/batch_saver.py && grep "RETURN_TYPES" nodes/batch_saver.py` shows IMAGE, STRING, STRING
    - `grep -q "RETURN_NAMES" nodes/batch_saver.py` confirms new attribute exists
    - `grep -q '"result":' nodes/batch_saver.py` confirms return structure changed
  </verify>
  <done>BatchImageSaver has RETURN_TYPES with 3 outputs, return statement includes result tuple with image passthrough and filename/path strings</done>
</task>

<task type="auto">
  <name>Task 2: Create BatchProgressFormatter node</name>
  <files>nodes/progress_formatter.py</files>
  <action>
Create new file `nodes/progress_formatter.py` with BatchProgressFormatter class:

```python
"""BatchProgressFormatter node for ComfyUI batch image processing."""


class BatchProgressFormatter:
    """
    Format batch progress as human-readable string.

    Takes INDEX (0-based) and TOTAL_COUNT from BatchImageLoader
    and outputs a formatted string like "3 of 10 (30%)".
    """

    CATEGORY = "batch_processing"
    RETURN_TYPES = ("STRING",)
    RETURN_NAMES = ("PROGRESS_TEXT",)
    FUNCTION = "format_progress"
    OUTPUT_NODE = False

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "index": (
                    "INT",
                    {
                        "default": 0,
                        "min": 0,
                        "forceInput": True,
                        "tooltip": "Wire from BatchImageLoader INDEX output",
                    },
                ),
                "total_count": (
                    "INT",
                    {
                        "default": 1,
                        "min": 0,
                        "forceInput": True,
                        "tooltip": "Wire from BatchImageLoader TOTAL_COUNT output",
                    },
                ),
            },
        }

    def format_progress(self, index: int, total_count: int) -> tuple:
        """
        Format progress as human-readable string.

        Args:
            index: 0-based index from BatchImageLoader
            total_count: Total number of images in batch

        Returns:
            Tuple containing formatted progress string
        """
        # Convert 0-based index to 1-based for human display
        current = index + 1

        # Protect against divide-by-zero
        safe_total = max(1, total_count)

        # Calculate percentage (integer, no decimals)
        percentage = int((current / safe_total) * 100)

        # Format: "3 of 10 (30%)"
        progress_text = f"{current} of {safe_total} ({percentage}%)"

        return (progress_text,)
```

Key implementation details:
- `forceInput: True` ensures users must wire from BatchImageLoader (not type values)
- Convert 0-based INDEX to 1-based for display ("1 of 10" not "0 of 10")
- Use `max(1, total_count)` to prevent divide-by-zero
- Integer percentage (no decimals)
- Format matches user decision: "X of Y (Z%)"
  </action>
  <verify>
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; print(BatchProgressFormatter.CATEGORY)"` prints "batch_processing"
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; f = BatchProgressFormatter(); print(f.format_progress(2, 10))"` prints `('3 of 10 (30%)',)`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; f = BatchProgressFormatter(); print(f.format_progress(0, 0))"` prints `('1 of 1 (100%)',)` (divide-by-zero protection)
  </verify>
  <done>BatchProgressFormatter node exists with INPUT_TYPES (index, total_count with forceInput), format_progress method returning formatted string, divide-by-zero protection</done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Verify BatchImageSaver has new outputs
grep "RETURN_TYPES" nodes/batch_saver.py
grep "RETURN_NAMES" nodes/batch_saver.py

# Verify BatchProgressFormatter exists and works
python -c "
from nodes.progress_formatter import BatchProgressFormatter
f = BatchProgressFormatter()
# Test normal case
result = f.format_progress(4, 10)
assert result == ('5 of 10 (50%)',), f'Got {result}'
# Test edge case (first image)
result = f.format_progress(0, 5)
assert result == ('1 of 5 (20%)',), f'Got {result}'
# Test divide-by-zero protection
result = f.format_progress(0, 0)
assert result == ('1 of 1 (100%)',), f'Got {result}'
print('All BatchProgressFormatter checks passed')
"
```
</verification>

<success_criteria>
1. BatchImageSaver.RETURN_TYPES = ("IMAGE", "STRING", "STRING")
2. BatchImageSaver.RETURN_NAMES = ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")
3. BatchImageSaver.save_image() returns {"ui": {...}, "result": (image, filename, path)}
4. BatchProgressFormatter exists in nodes/progress_formatter.py
5. BatchProgressFormatter.format_progress(2, 10) returns ("3 of 10 (30%)",)
6. BatchProgressFormatter handles total_count=0 without error
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-monitoring/04-01-SUMMARY.md`
</output>
