---
phase: 04-progress-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nodes/batch_saver.py
  - nodes/progress_formatter.py
autonomous: true
must_haves:
  truths:
    - "BatchImageSaver outputs the saved image for downstream wiring"
    - "BatchImageSaver outputs the saved filename and path"
    - "BatchProgressFormatter formats index and total as human-readable string"
    - "OUTPUT_IMAGE is the same tensor reference as the input (passthrough, no copy)"
    - "Skip mode returns empty strings '' for filename/path, but still passes through image"
    - "Rename mode returns the renamed filename/path (e.g., 'photo_1.png')"
  artifacts:
    - path: "nodes/batch_saver.py"
      provides: "Extended save node with passthrough outputs"
      contains: "RETURN_TYPES"
    - path: "nodes/progress_formatter.py"
      provides: "Progress text formatter node"
      exports: ["BatchProgressFormatter"]
  key_links:
    - from: "nodes/batch_saver.py"
      to: "downstream PreviewImage"
      via: "OUTPUT_IMAGE return value"
      pattern: "result.*image"
---

<objective>
Extend BatchImageSaver with passthrough outputs and create BatchProgressFormatter node.

Purpose: Enable progress visibility by (1) letting BatchImageSaver pass the image through for downstream preview wiring, and (2) providing a helper node to format progress as "X of Y (Z%)".

Output: Modified batch_saver.py with new outputs, new progress_formatter.py with BatchProgressFormatter class.
</objective>

<reference_patterns>
## ComfyUI Return Structure for OUTPUT_NODE with RETURN_TYPES (from 04-RESEARCH.md)

When a node has both `OUTPUT_NODE = True` and `RETURN_TYPES != ()`, the return format MUST be:
```python
return {
    "ui": {"images": [...]},  # UI preview data (existing)
    "result": (output1, output2, ...)  # Tuple matching RETURN_TYPES order
}
```

This is the documented pattern from ComfyUI nodes.py SaveImage implementation.

## BatchImageSaver Output Contract

| Return Type | Name | Normal Save | Skip Mode | Rename Mode |
|-------------|------|-------------|-----------|-------------|
| IMAGE | OUTPUT_IMAGE | Input tensor (passthrough) | Input tensor (passthrough) | Input tensor (passthrough) |
| STRING | SAVED_FILENAME | "photo.png" | "" (empty string) | "photo_1.png" |
| STRING | SAVED_PATH | "/full/path/photo.png" | "" (empty string) | "/full/path/photo_1.png" |

Key behavior:
- OUTPUT_IMAGE is ALWAYS the input tensor reference (no copy, no re-encoding)
- Skip mode: image still passes through even though no file was saved
- SAVED_FILENAME is just the basename (no path), SAVED_PATH is the full absolute path

## BatchProgressFormatter Specification

| Attribute | Value |
|-----------|-------|
| CATEGORY | "batch_processing" |
| RETURN_TYPES | ("STRING",) |
| RETURN_NAMES | ("PROGRESS_TEXT",) |
| FUNCTION | "format_progress" |
| OUTPUT_NODE | False |

### INPUT_TYPES Structure
```python
{
    "required": {
        "index": ("INT", {"default": 0, "min": 0, "forceInput": True, "tooltip": "..."}),
        "total_count": ("INT", {"default": 1, "min": 0, "forceInput": True, "tooltip": "..."}),
    }
}
```

### Formatting Rules
1. INDEX is 0-based (from BatchImageLoader) → convert to 1-based for display: `current = index + 1`
2. Percentage is INTEGER (truncated, not rounded): `int((current / safe_total) * 100)`
3. Divide-by-zero protection: `safe_total = max(1, total_count)`
4. Output format: `f"{current} of {safe_total} ({percentage}%)"`

### Example Inputs/Outputs
| index | total_count | Output |
|-------|-------------|--------|
| 0 | 10 | "1 of 10 (10%)" |
| 2 | 10 | "3 of 10 (30%)" |
| 9 | 10 | "10 of 10 (100%)" |
| 0 | 3 | "1 of 3 (33%)" |
| 0 | 0 | "1 of 1 (100%)" |
| 0 | 1 | "1 of 1 (100%)" |
</reference_patterns>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-progress-monitoring/04-CONTEXT.md
@.planning/phases/04-progress-monitoring/04-RESEARCH.md
@nodes/batch_saver.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BatchImageSaver with passthrough outputs</name>
  <files>nodes/batch_saver.py</files>
  <action>
Modify BatchImageSaver class to add outputs for downstream wiring.

**Reference pattern:** See 04-RESEARCH.md "Pattern 1: Adding Outputs to OUTPUT_NODE" and "Code Examples" section.

**Step 1: Update class attributes (around line 31)**

Change:
```python
RETURN_TYPES = ()
```

To:
```python
RETURN_TYPES = ("IMAGE", "STRING", "STRING")
RETURN_NAMES = ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")
```

Keep `OUTPUT_NODE = True` (still produces UI preview).

**Step 2: Modify save_image() normal return (around line 210-224)**

Current code returns:
```python
result = {
    "ui": {
        "images": [
            {
                "filename": os.path.basename(final_path),
                "subfolder": subfolder,
                "type": "output",
            }
        ]
    }
}
return result
```

Change to return (note: `final_path` and `subfolder` variables already exist):
```python
saved_filename = os.path.basename(final_path)
saved_path = final_path

return {
    "ui": {
        "images": [
            {
                "filename": saved_filename,
                "subfolder": subfolder,
                "type": "output",
            }
        ]
    },
    "result": (image, saved_filename, saved_path)
}
```

**Step 3: Modify save_image() skip mode return (line 178)**

Current code:
```python
return {"ui": {"images": []}}
```

Change to:
```python
return {"ui": {"images": []}, "result": (image, "", "")}
```

**Behavior contract:**
- OUTPUT_IMAGE: Same tensor reference as input (no copy, efficient passthrough)
- SAVED_FILENAME: Just the basename (e.g., "photo.png"), empty string "" if skipped
- SAVED_PATH: Full absolute path (e.g., "/path/to/photo.png"), empty string "" if skipped
- Skip mode: Image passes through (enables downstream preview), filename/path are empty
- Rename mode: Returns the RENAMED filename/path (e.g., "photo_1.png")
  </action>
  <verify>
    - `grep "RETURN_TYPES" nodes/batch_saver.py` outputs: `RETURN_TYPES = ("IMAGE", "STRING", "STRING")`
    - `grep "RETURN_NAMES" nodes/batch_saver.py` outputs: `RETURN_NAMES = ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")`
    - `grep -c '"result":' nodes/batch_saver.py` outputs: `2` (one for normal return, one for skip mode)
  </verify>
  <done>BatchImageSaver has RETURN_TYPES = ("IMAGE", "STRING", "STRING"), RETURN_NAMES defined, both return paths include "result" tuple with (image, saved_filename, saved_path)</done>
</task>

<task type="auto">
  <name>Task 2: Create BatchProgressFormatter node</name>
  <files>nodes/progress_formatter.py</files>
  <action>
Create new file `nodes/progress_formatter.py` with BatchProgressFormatter class.

**Reference pattern:** See 04-RESEARCH.md "Pattern 3: Simple Progress Formatter Node" and "Complete BatchProgressFormatter Implementation".

**File contents (exact implementation):**

```python
"""BatchProgressFormatter node for ComfyUI batch image processing."""


class BatchProgressFormatter:
    """
    Format batch progress as human-readable string.

    Takes INDEX (0-based) and TOTAL_COUNT from BatchImageLoader
    and outputs a formatted string like "3 of 10 (30%)".
    """

    CATEGORY = "batch_processing"
    RETURN_TYPES = ("STRING",)
    RETURN_NAMES = ("PROGRESS_TEXT",)
    FUNCTION = "format_progress"
    OUTPUT_NODE = False

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "index": (
                    "INT",
                    {
                        "default": 0,
                        "min": 0,
                        "forceInput": True,
                        "tooltip": "Wire from BatchImageLoader INDEX output",
                    },
                ),
                "total_count": (
                    "INT",
                    {
                        "default": 1,
                        "min": 0,
                        "forceInput": True,
                        "tooltip": "Wire from BatchImageLoader TOTAL_COUNT output",
                    },
                ),
            },
        }

    def format_progress(self, index: int, total_count: int) -> tuple:
        """
        Format progress as human-readable string.

        Args:
            index: 0-based index from BatchImageLoader
            total_count: Total number of images in batch

        Returns:
            Tuple containing formatted progress string
        """
        # Convert 0-based index to 1-based for human display
        current = index + 1

        # Protect against divide-by-zero
        safe_total = max(1, total_count)

        # Calculate percentage (integer, no decimals - uses int() which truncates)
        percentage = int((current / safe_total) * 100)

        # Format: "3 of 10 (30%)"
        progress_text = f"{current} of {safe_total} ({percentage}%)"

        return (progress_text,)
```

**Class Attribute Contract:**
| Attribute | Value | Purpose |
|-----------|-------|---------|
| CATEGORY | "batch_processing" | Groups with other batch nodes in ComfyUI menu |
| RETURN_TYPES | ("STRING",) | Single string output |
| RETURN_NAMES | ("PROGRESS_TEXT",) | Named output for wiring clarity |
| FUNCTION | "format_progress" | Method name ComfyUI calls |
| OUTPUT_NODE | False | Not a terminal node, produces downstream data |

**INPUT_TYPES Contract:**
- `forceInput: True` on BOTH inputs - hides widget, requires wire from BatchImageLoader
- `min: 0` - prevents negative values (defensive)
- `default` values used if node is somehow invoked without wires (shouldn't happen with forceInput)

**Formatting Rules (EXACT):**
1. `current = index + 1` - Convert 0-based to 1-based
2. `safe_total = max(1, total_count)` - Prevent divide-by-zero
3. `percentage = int((current / safe_total) * 100)` - Integer, truncated (not rounded)
4. Output format: `f"{current} of {safe_total} ({percentage}%)"`

**Expected Outputs (Test Cases):**
| index | total_count | Expected Output |
|-------|-------------|-----------------|
| 0 | 10 | "1 of 10 (10%)" |
| 2 | 10 | "3 of 10 (30%)" |
| 9 | 10 | "10 of 10 (100%)" |
| 0 | 3 | "1 of 3 (33%)" ← Note: 33.33% truncates to 33% |
| 0 | 0 | "1 of 1 (100%)" ← Divide-by-zero protection |
| 0 | 1 | "1 of 1 (100%)" |
| 4 | 10 | "5 of 10 (50%)" |
| 999 | 1000 | "1000 of 1000 (100%)" |
  </action>
  <verify>
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; print(BatchProgressFormatter.CATEGORY)"` prints: `batch_processing`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; print(BatchProgressFormatter.RETURN_TYPES)"` prints: `('STRING',)`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; print(BatchProgressFormatter.OUTPUT_NODE)"` prints: `False`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; f = BatchProgressFormatter(); print(f.format_progress(2, 10))"` prints: `('3 of 10 (30%)',)`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; f = BatchProgressFormatter(); print(f.format_progress(0, 3))"` prints: `('1 of 3 (33%)',)`
    - `python -c "from nodes.progress_formatter import BatchProgressFormatter; f = BatchProgressFormatter(); print(f.format_progress(0, 0))"` prints: `('1 of 1 (100%)',)`
  </verify>
  <done>BatchProgressFormatter node exists with all class attributes (CATEGORY, RETURN_TYPES, RETURN_NAMES, FUNCTION, OUTPUT_NODE=False), INPUT_TYPES with forceInput on both inputs, format_progress returns exact format with truncated percentage and divide-by-zero protection</done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Verify BatchImageSaver has new outputs
grep "RETURN_TYPES" nodes/batch_saver.py
grep "RETURN_NAMES" nodes/batch_saver.py

# Verify BatchProgressFormatter exists and works
python -c "
from nodes.progress_formatter import BatchProgressFormatter
f = BatchProgressFormatter()
# Test normal case
result = f.format_progress(4, 10)
assert result == ('5 of 10 (50%)',), f'Got {result}'
# Test edge case (first image)
result = f.format_progress(0, 5)
assert result == ('1 of 5 (20%)',), f'Got {result}'
# Test divide-by-zero protection
result = f.format_progress(0, 0)
assert result == ('1 of 1 (100%)',), f'Got {result}'
print('All BatchProgressFormatter checks passed')
"
```
</verification>

<success_criteria>
1. BatchImageSaver.RETURN_TYPES = ("IMAGE", "STRING", "STRING")
2. BatchImageSaver.RETURN_NAMES = ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")
3. BatchImageSaver.save_image() returns {"ui": {...}, "result": (image, filename, path)}
4. BatchProgressFormatter exists in nodes/progress_formatter.py
5. BatchProgressFormatter.format_progress(2, 10) returns ("3 of 10 (30%)",)
6. BatchProgressFormatter handles total_count=0 without error
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-monitoring/04-01-SUMMARY.md`
</output>
