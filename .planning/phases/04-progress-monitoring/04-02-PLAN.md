---
phase: 04-progress-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - __init__.py
  - tests/test_batch_saver.py
  - tests/test_progress_formatter.py
autonomous: true
must_haves:
  truths:
    - "BatchProgressFormatter appears in ComfyUI node menu as 'Batch Progress Formatter'"
    - "All existing BatchImageSaver tests still pass (no regressions)"
    - "New BatchImageSaver RETURN_TYPES = ('IMAGE', 'STRING', 'STRING') is tested"
    - "New BatchImageSaver RETURN_NAMES = ('OUTPUT_IMAGE', 'SAVED_FILENAME', 'SAVED_PATH') is tested"
    - "BatchImageSaver result tuple structure is tested (image passthrough, filename, path)"
    - "BatchImageSaver skip mode returns empty strings for filename/path"
    - "BatchProgressFormatter formatting logic is tested with concrete input/output cases"
    - "OUTPUT_IMAGE return type is IMAGE (enabling wiring to PreviewImage nodes)"
  artifacts:
    - path: "__init__.py"
      provides: "Node registration including BatchProgressFormatter"
      contains: "BatchProgressFormatter"
      exact_values:
        - "NODE_CLASS_MAPPINGS['BatchProgressFormatter'] = BatchProgressFormatter"
        - "NODE_DISPLAY_NAME_MAPPINGS['BatchProgressFormatter'] = 'Batch Progress Formatter'"
    - path: "tests/test_batch_saver.py"
      provides: "Updated tests for new return types"
      contains: "test_return_types_has_outputs"
      test_classes:
        - "TestReturnNames"
        - "TestSaveImageReturns"
    - path: "tests/test_progress_formatter.py"
      provides: "Tests for BatchProgressFormatter"
      test_classes:
        - "TestClassAttributes"
        - "TestInputTypes"
        - "TestFormatProgress"
        - "TestEdgeCases"
  key_links:
    - from: "__init__.py"
      to: "nodes/progress_formatter.py"
      via: "import and NODE_CLASS_MAPPINGS"
      pattern: "BatchProgressFormatter"
---

<objective>
Register BatchProgressFormatter in ComfyUI and add comprehensive tests.

Purpose: Complete the phase by (1) making the new node available in ComfyUI's menu and (2) ensuring all functionality is tested.

Output: Updated __init__.py with new node registration, updated test_batch_saver.py for new return types, new test_progress_formatter.py.
</objective>

<reference_contracts>
## From Plan 04-01: BatchImageSaver Return Structure

**RETURN_TYPES:** `("IMAGE", "STRING", "STRING")`
**RETURN_NAMES:** `("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")`

**Return value structure:**
```python
{
    "ui": {"images": [...]},
    "result": (image_tensor, saved_filename, saved_path)
}
```

**Output values by mode:**
| Mode | OUTPUT_IMAGE | SAVED_FILENAME | SAVED_PATH |
|------|--------------|----------------|------------|
| Normal | Input tensor (same reference) | "filename.png" | "/full/path/filename.png" |
| Skip | Input tensor (same reference) | "" (empty string) | "" (empty string) |
| Rename | Input tensor (same reference) | "filename_1.png" | "/full/path/filename_1.png" |

## From Plan 04-01: BatchProgressFormatter Specification

**Class attributes:**
- CATEGORY = "batch_processing"
- RETURN_TYPES = ("STRING",)
- RETURN_NAMES = ("PROGRESS_TEXT",)
- FUNCTION = "format_progress"
- OUTPUT_NODE = False

**INPUT_TYPES:**
- index: INT with forceInput=True
- total_count: INT with forceInput=True

**format_progress() test cases:**
| index | total_count | Expected Output |
|-------|-------------|-----------------|
| 0 | 10 | ("1 of 10 (10%)",) |
| 2 | 10 | ("3 of 10 (30%)",) |
| 9 | 10 | ("10 of 10 (100%)",) |
| 0 | 3 | ("1 of 3 (33%)",) |
| 0 | 0 | ("1 of 1 (100%)",) |
| 0 | 1 | ("1 of 1 (100%)",) |
| 4 | 10 | ("5 of 10 (50%)",) |
| 999 | 1000 | ("1000 of 1000 (100%)",) |

## Node Registration Values

**Exact values for __init__.py:**
- Import: `from .nodes.progress_formatter import BatchProgressFormatter`
- NODE_CLASS_MAPPINGS key: `"BatchProgressFormatter"`
- NODE_DISPLAY_NAME_MAPPINGS value: `"Batch Progress Formatter"` (with spaces)

## Test File Conventions (from existing tests/test_batch_saver.py)

- Import node via root package: `from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS`
- Get class: `BatchProgressFormatter = NODE_CLASS_MAPPINGS["BatchProgressFormatter"]`
- Use pytest fixtures (e.g., `temp_output_dir`)
- Class naming: `TestClassAttributes`, `TestInputTypes`, `TestFormatProgress`, etc.
- Test naming: `test_<what_is_being_tested>` (lowercase with underscores)
</reference_contracts>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-progress-monitoring/04-CONTEXT.md
@.planning/phases/04-progress-monitoring/04-01-SUMMARY.md
@__init__.py
@tests/test_batch_saver.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register BatchProgressFormatter in __init__.py</name>
  <files>__init__.py</files>
  <action>
Update __init__.py to register BatchProgressFormatter.

**Reference:** Existing __init__.py structure at @__init__.py

**Exact changes (inside the try block):**

**Step 1: Add import (after line 8)**

Current:
```python
from .nodes.batch_loader import BatchImageLoader
from .nodes.batch_saver import BatchImageSaver
```

Change to:
```python
from .nodes.batch_loader import BatchImageLoader
from .nodes.batch_saver import BatchImageSaver
from .nodes.progress_formatter import BatchProgressFormatter
```

**Step 2: Update NODE_CLASS_MAPPINGS (lines 10-13)**

Current:
```python
NODE_CLASS_MAPPINGS = {
    "BatchImageLoader": BatchImageLoader,
    "BatchImageSaver": BatchImageSaver,
}
```

Change to:
```python
NODE_CLASS_MAPPINGS = {
    "BatchImageLoader": BatchImageLoader,
    "BatchImageSaver": BatchImageSaver,
    "BatchProgressFormatter": BatchProgressFormatter,
}
```

**Step 3: Update NODE_DISPLAY_NAME_MAPPINGS (lines 15-18)**

Current:
```python
NODE_DISPLAY_NAME_MAPPINGS = {
    "BatchImageLoader": "Batch Image Loader",
    "BatchImageSaver": "Batch Image Saver",
}
```

Change to:
```python
NODE_DISPLAY_NAME_MAPPINGS = {
    "BatchImageLoader": "Batch Image Loader",
    "BatchImageSaver": "Batch Image Saver",
    "BatchProgressFormatter": "Batch Progress Formatter",
}
```

**Exact values (for verification):**
- Key in NODE_CLASS_MAPPINGS: `"BatchProgressFormatter"` (PascalCase, no spaces)
- Display name: `"Batch Progress Formatter"` (with spaces, for UI display)
  </action>
  <verify>
    - `python -c "from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS; print('BatchProgressFormatter' in NODE_CLASS_MAPPINGS)"` prints: `True`
    - `python -c "from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS; print(len(NODE_CLASS_MAPPINGS))"` prints: `3`
    - `python -c "from comfyui_batch_image_processing import NODE_DISPLAY_NAME_MAPPINGS; print(NODE_DISPLAY_NAME_MAPPINGS.get('BatchProgressFormatter'))"` prints: `Batch Progress Formatter`
  </verify>
  <done>BatchProgressFormatter is registered in NODE_CLASS_MAPPINGS with key "BatchProgressFormatter" and in NODE_DISPLAY_NAME_MAPPINGS with display name "Batch Progress Formatter"</done>
</task>

<task type="auto">
  <name>Task 2: Update test_batch_saver.py for new return types</name>
  <files>tests/test_batch_saver.py</files>
  <action>
Update tests/test_batch_saver.py to reflect the new return types.

**Reference:** Existing test structure at @tests/test_batch_saver.py

**Note:** `os`, `torch`, and `Image` are already imported (lines 1-9).

**Step 1: Update TestClassAttributes.test_return_types_empty (line 78-80)**

Current:
```python
def test_return_types_empty(self):
    """RETURN_TYPES is empty tuple (output node)."""
    assert BatchImageSaver.RETURN_TYPES == ()
```

Change to:
```python
def test_return_types_has_outputs(self):
    """RETURN_TYPES has IMAGE and STRING outputs for downstream wiring."""
    assert BatchImageSaver.RETURN_TYPES == ("IMAGE", "STRING", "STRING")
```

**Step 2: Add TestReturnNames class (after TestClassAttributes, before TestSaveImagePng)**

Insert after line 88 (after TestClassAttributes class):

```python
class TestReturnNames:
    """Tests for RETURN_NAMES attribute."""

    def test_return_names_defined(self):
        """RETURN_NAMES has correct output names."""
        assert BatchImageSaver.RETURN_NAMES == ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")
```

**Step 3: Add TestSaveImageReturns class (after TestReturnNames)**

```python
class TestSaveImageReturns:
    """Tests for save_image return values."""

    def test_returns_result_tuple(self, temp_output_dir):
        """save_image returns result tuple with image, filename, path."""
        tensor = torch.ones(1, 50, 50, 3, dtype=torch.float32)

        saver = BatchImageSaver()
        result = saver.save_image(
            image=tensor,
            output_file_type="png",
            quality=100,
            overwrite_mode="Overwrite",
            output_directory=temp_output_dir,
            output_base_name="test_returns",
        )

        # Check result structure - must have both "ui" and "result" keys
        assert "ui" in result
        assert "result" in result
        assert len(result["result"]) == 3

        # Check result values
        output_image, saved_filename, saved_path = result["result"]

        # Image should be the SAME tensor reference (passthrough, not a copy)
        assert output_image is tensor

        # Filename should be just the filename (no path)
        assert saved_filename == "test_returns.png"

        # Path should be full absolute path
        assert saved_path == os.path.join(temp_output_dir, "test_returns.png")

    def test_skip_mode_returns_empty_strings(self, temp_output_dir):
        """Skip mode returns empty strings for filename/path but still passes image."""
        # Create existing file to trigger skip
        filepath = os.path.join(temp_output_dir, "existing.png")
        Image.new("RGB", (50, 50), color="red").save(filepath)

        tensor = torch.ones(1, 50, 50, 3, dtype=torch.float32)

        saver = BatchImageSaver()
        result = saver.save_image(
            image=tensor,
            output_file_type="png",
            quality=100,
            overwrite_mode="Skip",
            output_directory=temp_output_dir,
            output_base_name="existing",
        )

        # Check result structure
        assert "result" in result
        output_image, saved_filename, saved_path = result["result"]

        # Image STILL passes through even when skipped (for downstream preview)
        assert output_image is tensor

        # Filename and path are empty strings (not None) when skipped
        assert saved_filename == ""
        assert saved_path == ""

    def test_rename_mode_returns_renamed_path(self, temp_output_dir):
        """Rename mode returns the actual renamed filename and path."""
        # Create existing file to trigger rename
        filepath = os.path.join(temp_output_dir, "photo.png")
        Image.new("RGB", (50, 50), color="red").save(filepath)

        tensor = torch.ones(1, 50, 50, 3, dtype=torch.float32)

        saver = BatchImageSaver()
        result = saver.save_image(
            image=tensor,
            output_file_type="png",
            quality=100,
            overwrite_mode="Rename",
            output_directory=temp_output_dir,
            output_base_name="photo",
        )

        output_image, saved_filename, saved_path = result["result"]

        # Image passes through
        assert output_image is tensor

        # Should return the RENAMED filename (photo_1.png)
        assert saved_filename == "photo_1.png"
        assert saved_path == os.path.join(temp_output_dir, "photo_1.png")
```

**Expected test assertions:**
| Test | Key Assertion |
|------|---------------|
| test_return_types_has_outputs | `RETURN_TYPES == ("IMAGE", "STRING", "STRING")` |
| test_return_names_defined | `RETURN_NAMES == ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")` |
| test_returns_result_tuple | `output_image is tensor` (same reference), `saved_filename == "test_returns.png"` |
| test_skip_mode_returns_empty_strings | `saved_filename == ""`, `saved_path == ""`, `output_image is tensor` |
| test_rename_mode_returns_renamed_path | `saved_filename == "photo_1.png"` |
  </action>
  <verify>
    - `pytest tests/test_batch_saver.py::TestClassAttributes::test_return_types_has_outputs -v` passes
    - `pytest tests/test_batch_saver.py::TestReturnNames -v` passes
    - `pytest tests/test_batch_saver.py::TestSaveImageReturns -v` passes (all 3 tests)
    - `pytest tests/test_batch_saver.py -v` all tests pass (no regressions from existing tests)
  </verify>
  <done>test_batch_saver.py updated with test_return_types_has_outputs (changed from test_return_types_empty), TestReturnNames class, and TestSaveImageReturns class with 3 tests for normal/skip/rename modes</done>
</task>

<task type="auto">
  <name>Task 3: Create test_progress_formatter.py</name>
  <files>tests/test_progress_formatter.py</files>
  <action>
Create new file `tests/test_progress_formatter.py` following the test conventions from test_batch_saver.py.

**Reference:** Test structure from @tests/test_batch_saver.py

**Complete file contents:**

```python
"""Tests for BatchProgressFormatter node."""

import pytest

# Import through root package (as ComfyUI would)
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS

BatchProgressFormatter = NODE_CLASS_MAPPINGS["BatchProgressFormatter"]


class TestClassAttributes:
    """Tests for class attributes."""

    def test_category(self):
        """CATEGORY is batch_processing."""
        assert BatchProgressFormatter.CATEGORY == "batch_processing"

    def test_return_types(self):
        """RETURN_TYPES is single STRING."""
        assert BatchProgressFormatter.RETURN_TYPES == ("STRING",)

    def test_return_names(self):
        """RETURN_NAMES is PROGRESS_TEXT."""
        assert BatchProgressFormatter.RETURN_NAMES == ("PROGRESS_TEXT",)

    def test_function_name(self):
        """FUNCTION is format_progress."""
        assert BatchProgressFormatter.FUNCTION == "format_progress"

    def test_not_output_node(self):
        """OUTPUT_NODE is False (not a terminal node)."""
        assert BatchProgressFormatter.OUTPUT_NODE is False


class TestInputTypes:
    """Tests for INPUT_TYPES class method."""

    def test_returns_dict_with_required(self):
        """INPUT_TYPES returns dict with required key."""
        result = BatchProgressFormatter.INPUT_TYPES()
        assert isinstance(result, dict)
        assert "required" in result

    def test_index_is_required_int_with_force_input(self):
        """index input is required INT with forceInput=True."""
        result = BatchProgressFormatter.INPUT_TYPES()
        index_config = result["required"]["index"]
        assert index_config[0] == "INT"
        assert index_config[1].get("forceInput") is True

    def test_total_count_is_required_int_with_force_input(self):
        """total_count input is required INT with forceInput=True."""
        result = BatchProgressFormatter.INPUT_TYPES()
        total_config = result["required"]["total_count"]
        assert total_config[0] == "INT"
        assert total_config[1].get("forceInput") is True


class TestFormatProgress:
    """Tests for format_progress method with concrete input/output cases."""

    def test_basic_formatting(self):
        """index=2, total_count=10 -> '3 of 10 (30%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=2, total_count=10)
        assert result == ("3 of 10 (30%)",)

    def test_first_image(self):
        """index=0, total_count=5 -> '1 of 5 (20%)' (0-based to 1-based conversion)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=5)
        assert result == ("1 of 5 (20%)",)

    def test_last_image(self):
        """index=9, total_count=10 -> '10 of 10 (100%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=9, total_count=10)
        assert result == ("10 of 10 (100%)",)

    def test_single_image(self):
        """index=0, total_count=1 -> '1 of 1 (100%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=1)
        assert result == ("1 of 1 (100%)",)

    def test_percentage_truncates_not_rounds(self):
        """index=0, total_count=3 -> '1 of 3 (33%)' (33.33% truncates to 33%, not rounds to 33%)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=3)
        assert result == ("1 of 3 (33%)",)

    def test_divide_by_zero_protection(self):
        """index=0, total_count=0 -> '1 of 1 (100%)' (max(1, total_count) prevents crash)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=0)
        assert result == ("1 of 1 (100%)",)

    def test_returns_tuple(self):
        """Returns a single-element tuple containing a string (ComfyUI requirement)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=10)
        assert isinstance(result, tuple)
        assert len(result) == 1
        assert isinstance(result[0], str)


class TestEdgeCases:
    """Tests for edge cases."""

    def test_large_numbers(self):
        """index=999, total_count=1000 -> '1000 of 1000 (100%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=999, total_count=1000)
        assert result == ("1000 of 1000 (100%)",)

    def test_midway_percentage(self):
        """index=4, total_count=10 -> '5 of 10 (50%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=4, total_count=10)
        assert result == ("5 of 10 (50%)",)

    def test_ten_percent(self):
        """index=0, total_count=10 -> '1 of 10 (10%)'."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=10)
        assert result == ("1 of 10 (10%)",)
```

**Test case matrix (all expected outputs):**
| Test Method | index | total_count | Expected Output |
|-------------|-------|-------------|-----------------|
| test_basic_formatting | 2 | 10 | ("3 of 10 (30%)",) |
| test_first_image | 0 | 5 | ("1 of 5 (20%)",) |
| test_last_image | 9 | 10 | ("10 of 10 (100%)",) |
| test_single_image | 0 | 1 | ("1 of 1 (100%)",) |
| test_percentage_truncates_not_rounds | 0 | 3 | ("1 of 3 (33%)",) |
| test_divide_by_zero_protection | 0 | 0 | ("1 of 1 (100%)",) |
| test_large_numbers | 999 | 1000 | ("1000 of 1000 (100%)",) |
| test_midway_percentage | 4 | 10 | ("5 of 10 (50%)",) |
| test_ten_percent | 0 | 10 | ("1 of 10 (10%)",) |
  </action>
  <verify>
    - `pytest tests/test_progress_formatter.py::TestClassAttributes -v` passes (5 tests)
    - `pytest tests/test_progress_formatter.py::TestInputTypes -v` passes (3 tests)
    - `pytest tests/test_progress_formatter.py::TestFormatProgress -v` passes (7 tests)
    - `pytest tests/test_progress_formatter.py::TestEdgeCases -v` passes (3 tests)
    - `pytest tests/test_progress_formatter.py -v` all 18 tests pass
  </verify>
  <done>test_progress_formatter.py created with 18 tests across 4 test classes: TestClassAttributes (5), TestInputTypes (3), TestFormatProgress (7), TestEdgeCases (3)</done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Run all tests to ensure no regressions
pytest tests/ -v

# Check specific test files
pytest tests/test_batch_saver.py -v
pytest tests/test_progress_formatter.py -v

# Verify node registration
python -c "
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS
assert 'BatchProgressFormatter' in NODE_CLASS_MAPPINGS
assert NODE_DISPLAY_NAME_MAPPINGS.get('BatchProgressFormatter') == 'Batch Progress Formatter'
print('Node registration verified')
"
```
</verification>

<success_criteria>
1. `"BatchProgressFormatter" in NODE_CLASS_MAPPINGS` is True
2. `NODE_DISPLAY_NAME_MAPPINGS["BatchProgressFormatter"]` == "Batch Progress Formatter"
3. All existing tests in test_batch_saver.py pass (no regressions)
4. test_batch_saver.py::TestClassAttributes::test_return_types_has_outputs asserts `RETURN_TYPES == ("IMAGE", "STRING", "STRING")`
5. test_batch_saver.py::TestReturnNames::test_return_names_defined asserts `RETURN_NAMES == ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")`
6. test_batch_saver.py::TestSaveImageReturns::test_returns_result_tuple asserts `output_image is tensor` and `saved_filename == "test_returns.png"`
7. test_batch_saver.py::TestSaveImageReturns::test_skip_mode_returns_empty_strings asserts `saved_filename == ""` and `saved_path == ""`
8. test_batch_saver.py::TestSaveImageReturns::test_rename_mode_returns_renamed_path asserts `saved_filename == "photo_1.png"`
9. test_progress_formatter.py has 18 tests across 4 classes (TestClassAttributes, TestInputTypes, TestFormatProgress, TestEdgeCases)
10. test_progress_formatter.py::TestFormatProgress::test_percentage_truncates_not_rounds asserts `("1 of 3 (33%)",)` (int truncation, not rounding)
11. test_progress_formatter.py::TestFormatProgress::test_divide_by_zero_protection asserts `("1 of 1 (100%)",)`
12. `pytest tests/` runs with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-monitoring/04-02-SUMMARY.md`
</output>
