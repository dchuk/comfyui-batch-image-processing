---
phase: 04-progress-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - __init__.py
  - tests/test_batch_saver.py
  - tests/test_progress_formatter.py
autonomous: true
must_haves:
  truths:
    - "BatchProgressFormatter appears in ComfyUI node menu"
    - "All existing BatchImageSaver tests still pass"
    - "New BatchImageSaver outputs are tested"
    - "BatchProgressFormatter formatting logic is tested"
  artifacts:
    - path: "__init__.py"
      provides: "Node registration including BatchProgressFormatter"
      contains: "BatchProgressFormatter"
    - path: "tests/test_batch_saver.py"
      provides: "Updated tests for new return types"
      contains: "RETURN_TYPES"
    - path: "tests/test_progress_formatter.py"
      provides: "Tests for BatchProgressFormatter"
      contains: "test_format"
  key_links:
    - from: "__init__.py"
      to: "nodes/progress_formatter.py"
      via: "import and NODE_CLASS_MAPPINGS"
      pattern: "BatchProgressFormatter"
---

<objective>
Register BatchProgressFormatter in ComfyUI and add comprehensive tests.

Purpose: Complete the phase by (1) making the new node available in ComfyUI's menu and (2) ensuring all functionality is tested.

Output: Updated __init__.py with new node registration, updated test_batch_saver.py for new return types, new test_progress_formatter.py.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-progress-monitoring/04-CONTEXT.md
@.planning/phases/04-progress-monitoring/04-01-SUMMARY.md
@__init__.py
@tests/test_batch_saver.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register BatchProgressFormatter in __init__.py</name>
  <files>__init__.py</files>
  <action>
Update __init__.py to register BatchProgressFormatter:

1. Add import inside the try block:
   `from .nodes.progress_formatter import BatchProgressFormatter`

2. Add to NODE_CLASS_MAPPINGS:
   `"BatchProgressFormatter": BatchProgressFormatter,`

3. Add to NODE_DISPLAY_NAME_MAPPINGS:
   `"BatchProgressFormatter": "Batch Progress Formatter",`

The resulting file should have all three nodes registered (BatchImageLoader, BatchImageSaver, BatchProgressFormatter).
  </action>
  <verify>
    - `python -c "from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS; print(list(NODE_CLASS_MAPPINGS.keys()))"` includes BatchProgressFormatter
    - `python -c "from comfyui_batch_image_processing import NODE_DISPLAY_NAME_MAPPINGS; print(NODE_DISPLAY_NAME_MAPPINGS.get('BatchProgressFormatter'))"` prints "Batch Progress Formatter"
  </verify>
  <done>BatchProgressFormatter is registered in NODE_CLASS_MAPPINGS and NODE_DISPLAY_NAME_MAPPINGS</done>
</task>

<task type="auto">
  <name>Task 2: Update test_batch_saver.py for new return types</name>
  <files>tests/test_batch_saver.py</files>
  <action>
Update tests/test_batch_saver.py to reflect the new return types:

1. Update TestClassAttributes.test_return_types_empty():
   - Rename to `test_return_types_has_outputs`
   - Change assertion from `== ()` to `== ("IMAGE", "STRING", "STRING")`

2. Add new test class `TestReturnNames`:
   ```python
   class TestReturnNames:
       """Tests for RETURN_NAMES attribute."""

       def test_return_names_defined(self):
           """RETURN_NAMES has correct output names."""
           assert BatchImageSaver.RETURN_NAMES == ("OUTPUT_IMAGE", "SAVED_FILENAME", "SAVED_PATH")
   ```

3. Add test class `TestSaveImageReturns`:
   ```python
   class TestSaveImageReturns:
       """Tests for save_image return values."""

       def test_returns_result_tuple(self, temp_output_dir):
           """save_image returns result tuple with image, filename, path."""
           tensor = torch.ones(1, 50, 50, 3, dtype=torch.float32)

           saver = BatchImageSaver()
           result = saver.save_image(
               image=tensor,
               output_file_type="png",
               quality=100,
               overwrite_mode="Overwrite",
               output_directory=temp_output_dir,
               output_base_name="test_returns",
           )

           # Check result structure
           assert "result" in result
           assert len(result["result"]) == 3

           # Check result values
           output_image, saved_filename, saved_path = result["result"]

           # Image should be the same tensor (passthrough)
           assert output_image is tensor

           # Filename should be just the filename
           assert saved_filename == "test_returns.png"

           # Path should be full path
           assert saved_path == os.path.join(temp_output_dir, "test_returns.png")

       def test_skip_mode_returns_empty_strings(self, temp_output_dir):
           """Skip mode returns empty strings for filename/path."""
           # Create existing file
           filepath = os.path.join(temp_output_dir, "existing.png")
           Image.new("RGB", (50, 50), color="red").save(filepath)

           tensor = torch.ones(1, 50, 50, 3, dtype=torch.float32)

           saver = BatchImageSaver()
           result = saver.save_image(
               image=tensor,
               output_file_type="png",
               quality=100,
               overwrite_mode="Skip",
               output_directory=temp_output_dir,
               output_base_name="existing",
           )

           # Check result structure
           assert "result" in result
           output_image, saved_filename, saved_path = result["result"]

           # Image still passed through
           assert output_image is tensor

           # Filename and path are empty when skipped
           assert saved_filename == ""
           assert saved_path == ""
   ```

Make sure to add import for `os` and `torch` if not already present at top of file.
  </action>
  <verify>
    - `pytest tests/test_batch_saver.py -v -k "test_return"` runs and passes new tests
    - `pytest tests/test_batch_saver.py -v` runs all tests successfully (no regressions)
  </verify>
  <done>test_batch_saver.py updated with tests for RETURN_TYPES, RETURN_NAMES, and result tuple structure</done>
</task>

<task type="auto">
  <name>Task 3: Create test_progress_formatter.py</name>
  <files>tests/test_progress_formatter.py</files>
  <action>
Create new file `tests/test_progress_formatter.py`:

```python
"""Tests for BatchProgressFormatter node."""

import pytest

# Import through root package (as ComfyUI would)
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS

BatchProgressFormatter = NODE_CLASS_MAPPINGS["BatchProgressFormatter"]


class TestClassAttributes:
    """Tests for class attributes."""

    def test_category(self):
        """CATEGORY is batch_processing."""
        assert BatchProgressFormatter.CATEGORY == "batch_processing"

    def test_return_types(self):
        """RETURN_TYPES is single STRING."""
        assert BatchProgressFormatter.RETURN_TYPES == ("STRING",)

    def test_return_names(self):
        """RETURN_NAMES is PROGRESS_TEXT."""
        assert BatchProgressFormatter.RETURN_NAMES == ("PROGRESS_TEXT",)

    def test_function_name(self):
        """FUNCTION is format_progress."""
        assert BatchProgressFormatter.FUNCTION == "format_progress"

    def test_not_output_node(self):
        """OUTPUT_NODE is False."""
        assert BatchProgressFormatter.OUTPUT_NODE is False


class TestInputTypes:
    """Tests for INPUT_TYPES class method."""

    def test_returns_dict_with_required(self):
        """INPUT_TYPES returns dict with required key."""
        result = BatchProgressFormatter.INPUT_TYPES()
        assert isinstance(result, dict)
        assert "required" in result

    def test_index_is_required_int_with_force_input(self):
        """index input is required INT with forceInput."""
        result = BatchProgressFormatter.INPUT_TYPES()
        index_config = result["required"]["index"]
        assert index_config[0] == "INT"
        assert index_config[1].get("forceInput") is True

    def test_total_count_is_required_int_with_force_input(self):
        """total_count input is required INT with forceInput."""
        result = BatchProgressFormatter.INPUT_TYPES()
        total_config = result["required"]["total_count"]
        assert total_config[0] == "INT"
        assert total_config[1].get("forceInput") is True


class TestFormatProgress:
    """Tests for format_progress method."""

    def test_basic_formatting(self):
        """Basic progress formatting works."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=2, total_count=10)
        assert result == ("3 of 10 (30%)",)

    def test_first_image(self):
        """First image (index 0) shows as 1."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=5)
        assert result == ("1 of 5 (20%)",)

    def test_last_image(self):
        """Last image shows 100%."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=9, total_count=10)
        assert result == ("10 of 10 (100%)",)

    def test_single_image(self):
        """Single image batch shows 1 of 1."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=1)
        assert result == ("1 of 1 (100%)",)

    def test_percentage_rounds_down(self):
        """Percentage is integer (truncated, not rounded)."""
        formatter = BatchProgressFormatter()
        # 1/3 = 33.33...% -> should be 33%
        result = formatter.format_progress(index=0, total_count=3)
        assert result == ("1 of 3 (33%)",)

    def test_divide_by_zero_protection(self):
        """total_count=0 doesn't crash (shows 1 of 1)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=0)
        assert result == ("1 of 1 (100%)",)

    def test_returns_tuple(self):
        """Returns a tuple (ComfyUI requirement)."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=0, total_count=10)
        assert isinstance(result, tuple)
        assert len(result) == 1
        assert isinstance(result[0], str)


class TestEdgeCases:
    """Tests for edge cases."""

    def test_large_numbers(self):
        """Works with large batch sizes."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=999, total_count=1000)
        assert result == ("1000 of 1000 (100%)",)

    def test_midway_percentage(self):
        """Midway through batch shows correct percentage."""
        formatter = BatchProgressFormatter()
        result = formatter.format_progress(index=4, total_count=10)
        assert result == ("5 of 10 (50%)",)
```
  </action>
  <verify>
    - `pytest tests/test_progress_formatter.py -v` runs all tests successfully
    - `pytest tests/test_progress_formatter.py -v --tb=short` shows no failures
  </verify>
  <done>test_progress_formatter.py created with comprehensive tests for class attributes, INPUT_TYPES, format_progress, and edge cases</done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Run all tests to ensure no regressions
pytest tests/ -v

# Check specific test files
pytest tests/test_batch_saver.py -v
pytest tests/test_progress_formatter.py -v

# Verify node registration
python -c "
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS
assert 'BatchProgressFormatter' in NODE_CLASS_MAPPINGS
assert NODE_DISPLAY_NAME_MAPPINGS.get('BatchProgressFormatter') == 'Batch Progress Formatter'
print('Node registration verified')
"
```
</verification>

<success_criteria>
1. BatchProgressFormatter is in NODE_CLASS_MAPPINGS
2. BatchProgressFormatter display name is "Batch Progress Formatter"
3. All existing tests in test_batch_saver.py pass
4. New tests for RETURN_TYPES/RETURN_NAMES/result tuple pass
5. All tests in test_progress_formatter.py pass
6. `pytest tests/` runs with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-monitoring/04-02-SUMMARY.md`
</output>
