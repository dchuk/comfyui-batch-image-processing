---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - __init__.py
  - nodes/__init__.py
  - nodes/batch_loader.py
  - utils/__init__.py
  - utils/sorting.py
  - utils/image_utils.py
  - tests/__init__.py
  - tests/conftest.py
  - tests/test_sorting.py
autonomous: true

must_haves:
  truths:
    - "BatchImageLoader appears in ComfyUI's Add Node menu under batch_processing category"
    - "Natural sort correctly orders img2 before img10"
    - "Project structure follows ComfyUI custom node conventions"
  artifacts:
    - path: "__init__.py"
      provides: "Node registration with NODE_CLASS_MAPPINGS"
      contains: "NODE_CLASS_MAPPINGS"
    - path: "nodes/batch_loader.py"
      provides: "BatchImageLoader class skeleton"
      contains: "class BatchImageLoader"
    - path: "utils/sorting.py"
      provides: "Natural sort implementation"
      exports: ["natural_sort_key"]
    - path: "utils/image_utils.py"
      provides: "Image loading utility"
      exports: ["load_image_as_tensor"]
  key_links:
    - from: "__init__.py"
      to: "nodes/batch_loader.py"
      via: "import"
      pattern: "from .nodes.batch_loader import"
    - from: "nodes/batch_loader.py"
      to: "utils/sorting.py"
      via: "import"
      pattern: "from ..utils.sorting import"
---

<objective>
Create the project structure and node registration for BatchImageLoader.

Purpose: Establish the foundational file structure and register a functional (but minimal) ComfyUI node that appears in the Add Node menu. This enables Plan 02 to implement the actual loading logic.

Output: Working ComfyUI custom node package with BatchImageLoader visible in menu, natural sort utility tested, image loading utility ready.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure with utility modules</name>
  <files>
    __init__.py
    nodes/__init__.py
    nodes/batch_loader.py
    utils/__init__.py
    utils/sorting.py
    utils/image_utils.py
  </files>
  <action>
Create the ComfyUI custom node package structure:

1. Create `utils/sorting.py`:
   - Implement `natural_sort_key(s: str) -> list` using regex split pattern
   - Pattern: `re.split(r'(\d+)', s)` with int conversion for digits, lowercase for text
   - Case-insensitive (lowercase all text parts)

2. Create `utils/image_utils.py`:
   - Implement `load_image_as_tensor(filepath: str) -> torch.Tensor`
   - Use PIL.Image.open(), ImageOps.exif_transpose() for EXIF rotation
   - Handle 'I' mode images (16-bit grayscale)
   - Convert to RGB, then to float32 numpy array [0.0, 1.0]
   - Return torch.Tensor with shape [1, H, W, C] (batch dimension via `[None,]`)

3. Create `utils/__init__.py`:
   - Export `natural_sort_key` and `load_image_as_tensor`

4. Create `nodes/batch_loader.py`:
   - Skeleton class `BatchImageLoader` with:
     - CATEGORY = "batch_processing"
     - INPUT_TYPES returning directory (STRING), filter_preset (COMBO with ["All Images", "PNG Only", "JPG Only", "Custom"]), and optional custom_pattern (STRING)
     - RETURN_TYPES = ("IMAGE", "INT", "INT", "STRING", "STRING")
     - RETURN_NAMES = ("IMAGE", "TOTAL_COUNT", "CURRENT_INDEX", "FILENAME", "BASENAME")
     - FUNCTION = "load_image"
     - Placeholder `load_image` method returning dummy values (will be completed in Plan 02)

5. Create `nodes/__init__.py`:
   - Export BatchImageLoader

6. Create root `__init__.py`:
   - Import BatchImageLoader from nodes
   - Define NODE_CLASS_MAPPINGS = {"BatchImageLoader": BatchImageLoader}
   - Define NODE_DISPLAY_NAME_MAPPINGS = {"BatchImageLoader": "Batch Image Loader"}
   - Export __all__ = ["NODE_CLASS_MAPPINGS", "NODE_DISPLAY_NAME_MAPPINGS"]

IMPORTANT: Use trailing commas in all tuples (e.g., `("IMAGE",)` not `("IMAGE")`).
  </action>
  <verify>
    - All files exist: `ls __init__.py nodes/batch_loader.py utils/sorting.py utils/image_utils.py`
    - Python syntax valid: `python -m py_compile __init__.py nodes/batch_loader.py utils/sorting.py utils/image_utils.py`
    - Imports work: `python -c "from nodes.batch_loader import BatchImageLoader; print(BatchImageLoader.CATEGORY)"`
  </verify>
  <done>
    - Project structure matches research recommendation
    - All Python files have valid syntax
    - BatchImageLoader can be imported and has CATEGORY = "batch_processing"
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test infrastructure and natural sort tests</name>
  <files>
    tests/__init__.py
    tests/conftest.py
    tests/test_sorting.py
    pyproject.toml
  </files>
  <action>
Create test infrastructure:

1. Create `tests/__init__.py` (empty file for package)

2. Create `tests/conftest.py`:
   - Add pytest fixtures for ComfyUI mocking (placeholder for now)
   - Add fixture for temporary directory with test images

3. Create `tests/test_sorting.py`:
   - Test `natural_sort_key` with these cases:
     - Basic numbers: ['img10', 'img2', 'img1'] -> ['img1', 'img2', 'img10']
     - Mixed case: ['IMG2.png', 'img1.png', 'Img10.png'] -> ['img1.png', 'IMG2.png', 'Img10.png']
     - No numbers: ['banana', 'apple', 'cherry'] -> ['apple', 'banana', 'cherry']
     - Leading zeros: ['img01', 'img001', 'img1'] -> all treated as 1
     - Multiple number groups: ['file1_page2', 'file1_page10', 'file2_page1']

4. Create `pyproject.toml` with:
   - pytest as dev dependency
   - Basic project metadata
   - No runtime dependencies (use ComfyUI-provided packages only)
  </action>
  <verify>
    - Run tests: `python -m pytest tests/test_sorting.py -v`
    - All tests pass
  </verify>
  <done>
    - Test infrastructure in place
    - Natural sort tests pass (at least 5 test cases)
    - pyproject.toml defines pytest dependency
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Structure verification:
   ```bash
   ls -la __init__.py nodes/ utils/ tests/
   ```

2. Import chain verification:
   ```bash
   python -c "from __init__ import NODE_CLASS_MAPPINGS; print(NODE_CLASS_MAPPINGS)"
   ```

3. Natural sort verification:
   ```bash
   python -c "from utils.sorting import natural_sort_key; print(sorted(['img10', 'img2', 'img1'], key=natural_sort_key))"
   ```
   Expected: `['img1', 'img2', 'img10']`

4. Tests pass:
   ```bash
   python -m pytest tests/ -v
   ```
</verification>

<success_criteria>
- BatchImageLoader class exists with correct CATEGORY, INPUT_TYPES, RETURN_TYPES
- NODE_CLASS_MAPPINGS exports the node correctly
- natural_sort_key sorts ['img10', 'img2', 'img1'] as ['img1', 'img2', 'img10']
- All pytest tests pass
- No external dependencies (only pytest for dev)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
