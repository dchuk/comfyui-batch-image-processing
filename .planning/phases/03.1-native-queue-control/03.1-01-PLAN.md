---
phase: 03.1-native-queue-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/queue_control.py
  - nodes/batch_loader.py
  - tests/test_queue_control.py
  - utils/__init__.py
autonomous: true

must_haves:
  truths:
    - "BatchImageLoader triggers next queue execution using native ComfyUI API (POST /prompt)"
    - "Batch completion stops iteration without requiring Impact Pack events"
    - "All existing Phase 3 tests continue to pass"
    - "No external custom node dependencies required for batch iteration"
  artifacts:
    - path: "utils/queue_control.py"
      provides: "Native queue trigger via HTTP POST to /prompt"
      contains: "urllib.request"
    - path: "nodes/batch_loader.py"
      provides: "Hidden inputs for accessing workflow prompt"
      contains: '"prompt": "PROMPT"'
    - path: "tests/test_queue_control.py"
      provides: "Updated tests for native queue control"
      contains: "urllib.request"
  key_links:
    - from: "nodes/batch_loader.py"
      to: "utils/queue_control.py"
      via: "trigger_next_queue(prompt)"
      pattern: "trigger_next_queue\\(.*prompt"
    - from: "utils/queue_control.py"
      to: "http://127.0.0.1:{port}/prompt"
      via: "urllib.request.urlopen"
      pattern: "urlopen.*prompt"
---

<objective>
Replace Impact Pack dependency with native ComfyUI queue control

Purpose: Remove external node dependency so batch iteration works without Impact Pack installed
Output: Queue control using native HTTP POST to `/prompt` endpoint with workflow from hidden inputs
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-native-queue-control/03.1-RESEARCH.md
@.planning/phases/03-batch-iteration/03-01-SUMMARY.md
@.planning/phases/03-batch-iteration/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace queue_control.py with native HTTP implementation</name>
  <files>utils/queue_control.py, utils/__init__.py</files>
  <action>
Replace the Impact Pack event-based queue control with native HTTP POST to ComfyUI's /prompt endpoint.

In `utils/queue_control.py`:

1. Add imports at top:
   - `import json`
   - `import uuid`
   - `import urllib.request`
   - `import urllib.error`

2. Add `get_server_address()` function:
   - Returns tuple of (address, port)
   - Get from `PromptServer.instance.address` and `.port` if available
   - Default to ('127.0.0.1', 8188)
   - Handle `address == '0.0.0.0'` case: use '127.0.0.1' for localhost calls

3. Replace `trigger_next_queue()` with `trigger_next_queue(prompt: dict) -> bool`:
   - Takes `prompt` parameter (the workflow dict from hidden input)
   - **Early return False if:**
     - `prompt` is None or empty dict (no workflow to queue)
     - `HAS_SERVER` is False (running outside ComfyUI, e.g., in tests)
     - `PromptServer.instance` is None (server not initialized)
   - Build payload: `{"prompt": prompt, "client_id": str(uuid.uuid4())}`
   - HTTP request construction (see research doc lines 302-313):
     ```python
     data = json.dumps(payload).encode('utf-8')
     req = urllib.request.Request(
         f"http://{address}:{port}/prompt",
         data=data,
         headers={'Content-Type': 'application/json'},
         method='POST'
     )
     with urllib.request.urlopen(req, timeout=5) as response:
         return response.status == 200
     ```
   - Catch `urllib.error.URLError`, `urllib.error.HTTPError`, and generic Exception - return False

4. Simplify `stop_auto_queue()`:
   - Remove the try/except with Impact Pack event
   - Simply return True (native approach: stopping = not queueing next, no event needed)
   - Keep function signature unchanged for API compatibility

   **Important: Auto-Queue behavior clarification:**
   Our system does NOT rely on ComfyUI's "Auto Queue" checkbox. We control iteration ourselves:
   - When batch continues: We POST to /prompt to queue next execution
   - When batch completes: We simply don't POST (no "stop" event needed)
   This works regardless of whether Auto Queue is enabled in ComfyUI UI.

5. Keep `should_continue()` unchanged - it has no Impact Pack dependency

In `utils/__init__.py`:
- No changes needed - exports remain the same

Key anti-patterns to avoid:
- Do NOT use `requests` library (not guaranteed in ComfyUI environment)
- Do NOT use `asyncio.run()` (conflicts with running event loop)
- Do NOT hardcode port 8188 (use PromptServer.instance.port)
- Do NOT use Impact Pack events (`impact-add-queue`, `impact-stop-auto-queue`)
  </action>
  <verify>
Run existing tests: `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/test_queue_control.py -v`
Tests will fail because they still expect Impact Pack events - this is expected and fixed in Task 3.
  </verify>
  <done>
`trigger_next_queue()` uses urllib.request POST to /prompt.
`stop_auto_queue()` simply returns True (no external events).
`get_server_address()` helper exists for address/port lookup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hidden inputs to BatchImageLoader and pass prompt to queue control</name>
  <files>nodes/batch_loader.py</files>
  <action>
Update BatchImageLoader to use ComfyUI hidden inputs for accessing the current workflow.

1. In `INPUT_TYPES()`, add `"hidden"` section after `"optional"`:
   ```python
   "hidden": {
       "prompt": "PROMPT",              # Complete workflow for re-queueing
       "extra_pnginfo": "EXTRA_PNGINFO",  # PNG metadata (for future use)
       "unique_id": "UNIQUE_ID",        # This node's ID (for future use)
   }
   ```

2. Update `load_image()` method signature to accept hidden inputs:
   ```python
   def load_image(
       self,
       directory: str,
       filter_preset: str,
       iteration_mode: str = "Continue",
       error_handling: str = "Stop on error",
       custom_pattern: str = "*.png,*.jpg,*.jpeg,*.webp",
       start_index: int = 0,
       # Hidden inputs
       prompt: dict = None,
       extra_pnginfo: dict = None,
       unique_id: str = None,
   ):
   ```

3. Pass prompt to `_load_with_error_handling()`:
   - Add `prompt: dict = None` parameter to method signature
   - Pass `prompt=prompt` in both recursive calls

4. Update queue control calls in `_load_with_error_handling()`:
   - Change `trigger_next_queue()` to `trigger_next_queue(prompt)`
   - Keep `stop_auto_queue()` call unchanged (it takes no parameters)

Key implementation notes:
- Hidden inputs are automatically populated by ComfyUI at runtime
- During tests (outside ComfyUI), prompt will be None - trigger_next_queue handles this
- extra_pnginfo and unique_id are included for future extensibility but not used yet
  </action>
  <verify>
Run: `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -c "from comfyui_batch_image_processing.nodes.batch_loader import BatchImageLoader; print(BatchImageLoader.INPUT_TYPES())"`
Should show hidden inputs in output.

Run: `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/test_batch_loader.py -v`
Existing batch_loader tests should still pass (they mock queue_control calls).
  </verify>
  <done>
BatchImageLoader.INPUT_TYPES() includes hidden section with prompt, extra_pnginfo, unique_id.
load_image() method accepts prompt, extra_pnginfo, unique_id parameters.
trigger_next_queue() is called with prompt argument.
All existing batch_loader tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests for native queue control</name>
  <files>tests/test_queue_control.py</files>
  <action>
Update tests to verify native HTTP POST behavior instead of Impact Pack events.

1. Update imports at top:
   - Add: `from unittest.mock import MagicMock, patch, Mock`
   - Add: `import urllib.request`
   - Add: `import urllib.error`

2. Keep `TestShouldContinue` class unchanged (no Impact Pack dependency)

3. Update `TestTriggerNextQueueNoServer`:
   - Rename to `TestTriggerNextQueueWithoutServer`
   - Test: `trigger_next_queue(None)` returns False (no prompt)
   - Test: `trigger_next_queue({})` returns False (empty prompt)
   - Test: `trigger_next_queue({"nodes": {}})` returns False when HAS_SERVER is False

4. Update `TestStopAutoQueueNoServer`:
   - Rename to `TestStopAutoQueueNative`
   - Test: `stop_auto_queue()` returns True (always succeeds, no external events)
   - Remove tests checking for Impact Pack events

5. Replace `TestTriggerNextQueueWithServer` with `TestTriggerNextQueueNative`:
   - Test: Calls urllib.request.urlopen with correct URL format
   - Test: POST payload contains prompt and client_id
   - Test: Returns True when response.status == 200
   - Test: Returns False when URLError raised
   - Test: Returns False when HTTPError raised
   - Test: Uses PromptServer.instance.address and .port for URL

   **Complete mock patterns for all test cases:**

   ```python
   # Pattern 1: Successful POST (status 200)
   @patch('comfyui_batch_image_processing.utils.queue_control.urllib.request.urlopen')
   @patch.object(queue_control, 'HAS_SERVER', True)
   @patch.object(queue_control, 'PromptServer')
   def test_posts_to_prompt_endpoint(self, mock_server, mock_urlopen):
       mock_server.instance.address = '127.0.0.1'
       mock_server.instance.port = 8188
       mock_response = Mock()
       mock_response.status = 200
       mock_response.__enter__ = Mock(return_value=mock_response)
       mock_response.__exit__ = Mock(return_value=False)
       mock_urlopen.return_value = mock_response

       result = trigger_next_queue({"nodes": {"1": {}}})

       assert result is True
       mock_urlopen.assert_called_once()
       # Verify URL contains /prompt
       call_args = mock_urlopen.call_args
       request = call_args[0][0]
       assert '/prompt' in request.full_url
       assert request.method == 'POST'
       assert request.get_header('Content-type') == 'application/json'

   # Pattern 2: URLError (network unreachable)
   @patch('comfyui_batch_image_processing.utils.queue_control.urllib.request.urlopen')
   @patch.object(queue_control, 'HAS_SERVER', True)
   @patch.object(queue_control, 'PromptServer')
   def test_returns_false_on_url_error(self, mock_server, mock_urlopen):
       mock_server.instance.address = '127.0.0.1'
       mock_server.instance.port = 8188
       mock_urlopen.side_effect = urllib.error.URLError('Connection refused')

       result = trigger_next_queue({"nodes": {"1": {}}})

       assert result is False

   # Pattern 3: HTTPError (server error)
   @patch('comfyui_batch_image_processing.utils.queue_control.urllib.request.urlopen')
   @patch.object(queue_control, 'HAS_SERVER', True)
   @patch.object(queue_control, 'PromptServer')
   def test_returns_false_on_http_error(self, mock_server, mock_urlopen):
       mock_server.instance.address = '127.0.0.1'
       mock_server.instance.port = 8188
       mock_urlopen.side_effect = urllib.error.HTTPError(
           'http://127.0.0.1:8188/prompt', 500, 'Server Error', {}, None
       )

       result = trigger_next_queue({"nodes": {"1": {}}})

       assert result is False

   # Pattern 4: HAS_SERVER=False (outside ComfyUI)
   @patch.object(queue_control, 'HAS_SERVER', False)
   def test_returns_false_when_no_server(self):
       result = trigger_next_queue({"nodes": {"1": {}}})
       assert result is False  # No network call made
   ```

6. Replace `TestStopAutoQueueWithServer` with simpler tests:
   - Test: Always returns True (no server interaction needed)
   - Remove all tests checking for Impact Pack events

7. Add `TestGetServerAddress` class:
   - Test: Returns ('127.0.0.1', 8188) when HAS_SERVER is False
   - Test: Returns server address/port when available
   - Test: Returns '127.0.0.1' when address is '0.0.0.0'

Run all tests to verify no regressions:
`python -m pytest tests/ -v`
  </action>
  <verify>
Run: `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/test_queue_control.py -v`
All queue_control tests should pass.

Run: `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/ -v`
ALL tests should pass (full test suite including batch_loader, iteration_state, etc.)
  </verify>
  <done>
Tests verify native HTTP POST behavior (urllib.request to /prompt).
Tests verify stop_auto_queue simply returns True.
No references to Impact Pack events in tests.
Full test suite passes with 0 failures.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Verify no Impact Pack references remain:**
   ```bash
   grep -r "impact-add-queue\|impact-stop-auto-queue" utils/ nodes/ tests/
   ```
   Should return no results.

2. **Verify native implementation present:**
   ```bash
   grep -l "urllib.request" utils/queue_control.py
   grep -l '"prompt": "PROMPT"' nodes/batch_loader.py
   ```
   Both should return matches.

3. **Run full test suite:**
   ```bash
   python -m pytest tests/ -v
   ```
   All tests must pass.

4. **Verify imports work correctly:**
   ```bash
   python -c "from comfyui_batch_image_processing.utils.queue_control import trigger_next_queue, stop_auto_queue, get_server_address, should_continue, HAS_SERVER; print('OK')"
   ```
   Should print "OK".
</verification>

<success_criteria>
- trigger_next_queue() uses native HTTP POST to /prompt (not Impact Pack events)
- stop_auto_queue() returns True without sending external events
- BatchImageLoader uses hidden inputs to access workflow prompt
- All 150+ existing tests pass
- No references to "impact-add-queue" or "impact-stop-auto-queue" in codebase
- get_server_address() helper function exists for address/port lookup
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-native-queue-control/03.1-01-SUMMARY.md`
</output>
