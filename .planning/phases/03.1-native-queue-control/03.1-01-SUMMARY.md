---
phase: 03.1-native-queue-control
plan: 01
subsystem: nodes
tags: [urllib, comfyui, queue-control, hidden-inputs]

# Dependency graph
requires:
  - phase: 03-batch-iteration
    provides: BatchImageLoader with queue control calls
provides:
  - Native HTTP POST queue triggering via urllib.request
  - Hidden inputs (prompt, extra_pnginfo, unique_id) for workflow access
  - get_server_address() helper for dynamic port detection
affects: [04-progress-display]

# Tech tracking
tech-stack:
  added: [urllib.request, urllib.error]
  patterns: [native-queue-control, hidden-inputs]

key-files:
  created: []
  modified: [utils/queue_control.py, nodes/batch_loader.py, tests/test_queue_control.py, tests/test_batch_loader.py]

key-decisions:
  - "Use urllib.request instead of requests library for guaranteed availability"
  - "stop_auto_queue() simply returns True - stopping is implicit (no event needed)"
  - "Handle 0.0.0.0 address by converting to 127.0.0.1 for HTTP calls"

patterns-established:
  - "Native queue control: POST to /prompt with workflow dict from hidden PROMPT input"
  - "Hidden inputs pattern: Add hidden section to INPUT_TYPES with PROMPT, EXTRA_PNGINFO, UNIQUE_ID"

# Metrics
duration: 6min
completed: 2026-02-02
---

# Phase 3.1: Native Queue Control Summary

**Native HTTP POST queue triggering via urllib.request to /prompt endpoint, removing Impact Pack dependency**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-02T16:51:25Z
- **Completed:** 2026-02-02T16:57:43Z
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments
- Replaced Impact Pack events with native HTTP POST to ComfyUI's /prompt endpoint
- Added hidden inputs to BatchImageLoader for accessing current workflow
- Updated all tests to verify native HTTP behavior instead of Impact Pack events
- Full test suite passes (170 tests)

## Task Commits

Each task was committed atomically:

1. **Task 1: Replace queue_control.py with native HTTP implementation** - `73c57ef` (feat)
2. **Task 2: Add hidden inputs to BatchImageLoader and pass prompt to queue control** - `5807431` (feat)
3. **Task 3: Update tests for native queue control** - `6886441` (test)

## Files Created/Modified
- `utils/queue_control.py` - Native HTTP POST to /prompt, get_server_address() helper
- `nodes/batch_loader.py` - Hidden inputs for PROMPT, EXTRA_PNGINFO, UNIQUE_ID
- `tests/test_queue_control.py` - Tests for urllib.request behavior
- `tests/test_batch_loader.py` - Updated test for hidden inputs

## Decisions Made
- **urllib.request over requests:** Used urllib.request from Python stdlib instead of requests library because requests is not guaranteed to be in all ComfyUI environments
- **Implicit stopping:** stop_auto_queue() returns True without sending any event - native approach means "stopping" is simply not queueing the next execution
- **Address conversion:** When server address is 0.0.0.0 (listen on all interfaces), convert to 127.0.0.1 for HTTP calls since we're calling localhost

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Batch iteration now works without Impact Pack installed
- Ready for Phase 4: Progress display
- All 170 tests passing

---
*Phase: 03.1-native-queue-control*
*Completed: 2026-02-02*
