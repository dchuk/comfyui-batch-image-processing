---
phase: 02-image-saving
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - __init__.py
  - nodes/__init__.py
  - utils/__init__.py
autonomous: true

must_haves:
  truths:
    - "BatchImageSaver appears in NODE_CLASS_MAPPINGS"
    - "BatchImageSaver has display name 'Batch Image Saver'"
    - "save_image_utils exports are available from utils package"
    - "Node registration works without errors when torch is available"
  artifacts:
    - path: "__init__.py"
      provides: "Root package with BatchImageSaver registration"
      contains: "BatchImageSaver"
    - path: "nodes/__init__.py"
      provides: "Nodes subpackage with BatchImageSaver export"
      contains: "BatchImageSaver"
    - path: "utils/__init__.py"
      provides: "Utils subpackage with save utilities exported"
      contains: "save_image_utils"
  key_links:
    - from: "__init__.py"
      to: "nodes/batch_saver.py"
      via: "import"
      pattern: "from.*batch_saver import BatchImageSaver"
    - from: "nodes/__init__.py"
      to: "nodes/batch_saver.py"
      via: "export"
      pattern: "from.*batch_saver import"
---

<objective>
Register BatchImageSaver node in package exports and verify full integration.

Purpose: Makes BatchImageSaver discoverable by ComfyUI and completes Phase 2 requirements.
Output: Fully registered node ready for use in ComfyUI workflows.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-image-saving/02-01-SUMMARY.md

# Existing registration patterns
@__init__.py
@nodes/__init__.py
@utils/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update package exports</name>
  <files>__init__.py, nodes/__init__.py, utils/__init__.py</files>
  <action>
**Update `nodes/__init__.py`:**
Add BatchImageSaver import alongside BatchImageLoader:
```python
"""ComfyUI batch processing nodes."""

from .batch_loader import BatchImageLoader
from .batch_saver import BatchImageSaver

__all__ = ["BatchImageLoader", "BatchImageSaver"]
```

**Update `utils/__init__.py`:**
Add conditional exports for save_image_utils functions:
```python
"""Utility modules for batch image processing."""

# Always export modules without external dependencies
from .sorting import natural_sort_key
from .file_utils import filter_files_by_patterns, get_pattern_for_preset

# Conditionally export functions that require numpy, torch, PIL
try:
    from .image_utils import load_image_as_tensor
    from .save_image_utils import (
        tensor_to_pil,
        save_with_format,
        construct_filename,
        handle_existing_file,
        resolve_output_directory,
    )

    __all__ = [
        "natural_sort_key",
        "filter_files_by_patterns",
        "get_pattern_for_preset",
        "load_image_as_tensor",
        "tensor_to_pil",
        "save_with_format",
        "construct_filename",
        "handle_existing_file",
        "resolve_output_directory",
    ]
except ImportError:
    # Allow import to succeed even without ComfyUI dependencies
    __all__ = ["natural_sort_key", "filter_files_by_patterns", "get_pattern_for_preset"]
```

**Update root `__init__.py`:**
Add BatchImageSaver to NODE_CLASS_MAPPINGS and NODE_DISPLAY_NAME_MAPPINGS:
```python
"""ComfyUI Batch Image Processing Nodes."""

try:
    from .nodes.batch_loader import BatchImageLoader
    from .nodes.batch_saver import BatchImageSaver

    NODE_CLASS_MAPPINGS = {
        "BatchImageLoader": BatchImageLoader,
        "BatchImageSaver": BatchImageSaver,
    }

    NODE_DISPLAY_NAME_MAPPINGS = {
        "BatchImageLoader": "Batch Image Loader",
        "BatchImageSaver": "Batch Image Saver",
    }

    __all__ = ["NODE_CLASS_MAPPINGS", "NODE_DISPLAY_NAME_MAPPINGS"]

except ImportError:
    NODE_CLASS_MAPPINGS = {}
    NODE_DISPLAY_NAME_MAPPINGS = {}
    __all__ = ["NODE_CLASS_MAPPINGS", "NODE_DISPLAY_NAME_MAPPINGS"]
```
  </action>
  <verify>
Run the following commands:
```bash
cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing
python -c "from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS; print('BatchImageSaver' in NODE_CLASS_MAPPINGS)"
python -c "from comfyui_batch_image_processing import NODE_DISPLAY_NAME_MAPPINGS; print(NODE_DISPLAY_NAME_MAPPINGS.get('BatchImageSaver'))"
```
First command prints `True`, second prints `Batch Image Saver`
  </verify>
  <done>
BatchImageSaver is registered in NODE_CLASS_MAPPINGS with display name "Batch Image Saver". Package exports work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify integration</name>
  <files></files>
  <action>
Run the complete test suite to ensure no regressions and all new functionality works:

1. Run all tests:
```bash
cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing
python -m pytest tests/ -v
```

2. Verify import chain works end-to-end:
```bash
python -c "
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS
print('Registered nodes:', list(NODE_CLASS_MAPPINGS.keys()))
print('Display names:', NODE_DISPLAY_NAME_MAPPINGS)

# Verify BatchImageSaver has correct attributes
saver = NODE_CLASS_MAPPINGS['BatchImageSaver']
print('OUTPUT_NODE:', saver.OUTPUT_NODE)
print('RETURN_TYPES:', saver.RETURN_TYPES)
print('FUNCTION:', saver.FUNCTION)
print('CATEGORY:', saver.CATEGORY)
"
```

3. Verify INPUT_TYPES includes all expected fields:
```bash
python -c "
from comfyui_batch_image_processing import NODE_CLASS_MAPPINGS
saver = NODE_CLASS_MAPPINGS['BatchImageSaver']
inputs = saver.INPUT_TYPES()
required = inputs['required']
optional = inputs['optional']

# Check required fields
assert 'image' in required, 'Missing image input'
assert 'output_format' in required, 'Missing output_format'
assert 'quality' in required, 'Missing quality'
assert 'overwrite_mode' in required, 'Missing overwrite_mode'

# Check optional fields
assert 'output_directory' in optional, 'Missing output_directory'
assert 'filename_prefix' in optional, 'Missing filename_prefix'
assert 'filename_suffix' in optional, 'Missing filename_suffix'
assert 'original_filename' in optional, 'Missing original_filename'
assert 'source_directory' in optional, 'Missing source_directory'
assert 'original_format' in optional, 'Missing original_format'

print('All INPUT_TYPES fields verified!')
"
```

If any tests fail, fix the issues before proceeding.
  </action>
  <verify>
All pytest tests pass. All three verification scripts complete without errors.
  </verify>
  <done>
Full test suite passes. Import chain works. BatchImageSaver is properly registered with all expected attributes and input types.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` - all tests pass
2. `NODE_CLASS_MAPPINGS` contains both BatchImageLoader and BatchImageSaver
3. `NODE_DISPLAY_NAME_MAPPINGS` has correct display names
4. BatchImageSaver.OUTPUT_NODE == True
5. BatchImageSaver.RETURN_TYPES == ()
6. BatchImageSaver.INPUT_TYPES() includes all required and optional fields
</verification>

<success_criteria>
- All existing tests still pass (no regressions)
- BatchImageSaver registered in NODE_CLASS_MAPPINGS
- Display name is "Batch Image Saver"
- Node exports work with graceful fallback when torch unavailable
- Phase 2 requirements SAVE-01 through SAVE-09 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-image-saving/02-02-SUMMARY.md`
</output>
