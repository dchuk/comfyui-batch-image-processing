---
phase: 02-image-saving
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/save_image_utils.py
  - nodes/batch_saver.py
  - tests/test_save_image_utils.py
autonomous: true

must_haves:
  truths:
    - "Image tensor can be converted to PIL Image"
    - "Image can be saved as PNG, JPG, or WebP with quality settings"
    - "Output filename is constructed from prefix + original + suffix + extension"
    - "Existing files are handled according to overwrite mode"
    - "Output directory resolves to ComfyUI output + source folder when not specified"
  artifacts:
    - path: "utils/save_image_utils.py"
      provides: "Image saving utilities"
      exports: ["tensor_to_pil", "save_with_format", "construct_filename", "handle_existing_file", "resolve_output_directory"]
    - path: "nodes/batch_saver.py"
      provides: "BatchImageSaver node class"
      exports: ["BatchImageSaver"]
    - path: "tests/test_save_image_utils.py"
      provides: "Unit tests for save utilities"
      min_lines: 80
  key_links:
    - from: "nodes/batch_saver.py"
      to: "utils/save_image_utils.py"
      via: "import"
      pattern: "from.*save_image_utils import"
    - from: "utils/save_image_utils.py"
      to: "PIL.Image"
      via: "save method"
      pattern: "img\\.save\\("
---

<objective>
Create BatchImageSaver node with supporting utilities for saving processed images with customizable formats, filenames, and overwrite behavior.

Purpose: Enables saving processed images immediately after pipeline execution with user-controlled naming and format options.
Output: Working save utilities and BatchImageSaver node ready for registration.
</objective>

<execution_context>
@./.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-image-saving/02-CONTEXT.md
@.planning/phases/02-image-saving/02-RESEARCH.md

# Existing codebase patterns
@__init__.py
@nodes/batch_loader.py
@utils/image_utils.py
@utils/file_utils.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create save image utilities</name>
  <files>utils/save_image_utils.py, tests/test_save_image_utils.py</files>
  <action>
Create `utils/save_image_utils.py` with these functions:

1. **tensor_to_pil(tensor)** - Convert ComfyUI tensor to PIL Image
   - Handle batch dimension: if len(tensor.shape) == 4, squeeze(0)
   - Convert: (255.0 * tensor.cpu().numpy()).clip(0, 255).astype(np.uint8)
   - Return Image.fromarray(array)

2. **save_with_format(img, filepath, format, quality)** - Save PIL image with format-specific options
   - PNG: img.save(filepath, "PNG", compress_level=4)
   - JPG/JPEG: convert RGBA to RGB first, img.save(filepath, "JPEG", quality=min(95, quality))
   - WebP: img.save(filepath, "WEBP", quality=quality, lossless=(quality == 100))
   - Default to PNG for unknown formats

3. **construct_filename(original_basename, prefix, suffix, extension)** - Build output filename
   - Pattern: f"{prefix}{original_basename}{suffix}.{extension}"
   - Raw concatenation per user decision (no automatic separators)

4. **handle_existing_file(filepath, mode)** - Handle existing files per mode
   - Return tuple[str, bool] = (final_path, should_save)
   - If file doesn't exist: return (filepath, True)
   - "Overwrite": return (filepath, True)
   - "Skip": print(f"Skipped: {os.path.basename(filepath)}"), return (filepath, False)
   - "Rename": simple increment photo_1.png, photo_2.png (not zero-padded), max 10000 attempts

5. **resolve_output_directory(output_dir, source_dir, default_output_func)** - Resolve output path
   - If output_dir specified and not empty: use it directly
   - Else: call default_output_func() to get ComfyUI output, join with basename of source_dir
   - Create directory with os.makedirs(resolved, exist_ok=True)
   - Return resolved path

Use graceful imports for torch/numpy/PIL (try/except pattern from existing utils).

Create `tests/test_save_image_utils.py` with tests for:
- construct_filename with various prefix/suffix combinations
- handle_existing_file for all three modes
- resolve_output_directory with and without output_dir specified
- save_with_format for PNG/JPG/WebP (using temp files and real PIL images)
- tensor_to_pil (requires torch, mark with pytest.mark.skipif if torch unavailable)
  </action>
  <verify>
Run `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/test_save_image_utils.py -v` - all tests pass
  </verify>
  <done>
All 5 utility functions exist with correct signatures. Tests cover construct_filename, handle_existing_file, resolve_output_directory, and save_with_format. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatchImageSaver node</name>
  <files>nodes/batch_saver.py</files>
  <action>
Create `nodes/batch_saver.py` with BatchImageSaver class following batch_loader.py patterns:

**Class structure:**
```python
try:
    import folder_paths
except ImportError:
    folder_paths = None  # For testing outside ComfyUI

class BatchImageSaver:
    CATEGORY = "batch_processing"
    RETURN_TYPES = ()
    FUNCTION = "save_image"
    OUTPUT_NODE = True
```

**INPUT_TYPES (classmethod):**
```python
return {
    "required": {
        "image": ("IMAGE", {"tooltip": "Image tensor from processing pipeline"}),
        "output_format": (
            ["Match original", "PNG", "JPG", "WebP"],
            {"default": "Match original"},
        ),
        "quality": (
            "INT",
            {"default": 100, "min": 1, "max": 100, "step": 1,
             "tooltip": "Quality for JPG/WebP (1-100). PNG ignores this."},
        ),
        "overwrite_mode": (
            ["Overwrite", "Skip", "Rename"],
            {"default": "Overwrite"},
        ),
    },
    "optional": {
        "output_directory": (
            "STRING",
            {"default": "", "tooltip": "Output directory (empty = ComfyUI output + source folder name)"},
        ),
        "filename_prefix": (
            "STRING",
            {"default": "", "tooltip": "Prefix for output filename (include separators)"},
        ),
        "filename_suffix": (
            "STRING",
            {"default": "", "tooltip": "Suffix for output filename (include separators)"},
        ),
        "original_filename": (
            "STRING",
            {"default": "", "tooltip": "Original filename from BatchImageLoader (BASENAME output)"},
        ),
        "source_directory": (
            "STRING",
            {"default": "", "tooltip": "Source directory for default subfolder naming"},
        ),
        "original_format": (
            "STRING",
            {"default": "png", "tooltip": "Original format (for Match original mode)"},
        ),
    },
}
```

**save_image method:**
1. Determine output format:
   - If "Match original": use original_format (default to "png")
   - Else: map "PNG"/"JPG"/"WebP" to lowercase extension

2. Determine base filename:
   - If original_filename provided: use it (already without extension from BASENAME)
   - Else: generate "output_NNNN" with random 4-digit number

3. Construct output path:
   - Call resolve_output_directory(output_directory, source_directory, lambda: folder_paths.get_output_directory() if folder_paths else "")
   - Call construct_filename(basename, prefix, suffix, extension)
   - Join directory + filename

4. Handle existing file:
   - Call handle_existing_file(filepath, overwrite_mode)
   - If should_save is False: return {"ui": {"images": []}}

5. Convert and save:
   - Call tensor_to_pil(image)
   - Call save_with_format(pil_img, final_path, format, quality)

6. Return UI dict:
   - Calculate subfolder relative to folder_paths.get_output_directory()
   - Return {"ui": {"images": [{"filename": ..., "subfolder": ..., "type": "output"}]}}

Import utilities from ..utils.save_image_utils.
  </action>
  <verify>
Run `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -c "from nodes.batch_saver import BatchImageSaver; print(BatchImageSaver.INPUT_TYPES())"` - prints INPUT_TYPES dict without error
  </verify>
  <done>
BatchImageSaver class exists with CATEGORY, INPUT_TYPES, RETURN_TYPES, FUNCTION, OUTPUT_NODE, and save_image method. Node follows ComfyUI OUTPUT_NODE pattern.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for BatchImageSaver</name>
  <files>tests/test_batch_saver.py, tests/conftest.py</files>
  <action>
Add output directory fixture to `tests/conftest.py`:
```python
@pytest.fixture
def temp_output_dir():
    """Create a temporary output directory for save tests."""
    with tempfile.TemporaryDirectory() as tmpdir:
        yield tmpdir
```

Create `tests/test_batch_saver.py` with tests:

1. **Test INPUT_TYPES structure** - Verify all required and optional fields exist with correct types

2. **Test class attributes** - Verify CATEGORY, RETURN_TYPES, FUNCTION, OUTPUT_NODE

3. **Test save_image with PNG format** - Create real tensor, save as PNG, verify file exists

4. **Test save_image with JPG format** - Create real tensor, save as JPG, verify file exists and is valid JPEG

5. **Test save_image with WebP format** - Create real tensor, save as WebP, verify file exists

6. **Test save_image with "Match original"** - Pass original_format="jpg", verify .jpg output

7. **Test filename construction** - Verify prefix/suffix applied correctly

8. **Test overwrite Skip mode** - Create existing file, call save with Skip, verify original unchanged

9. **Test overwrite Rename mode** - Create existing file, call save with Rename, verify new file _1.ext created

10. **Test default output directory** - Mock folder_paths, verify subfolder created from source_directory

Tests should create real tensors using torch (or skip if torch unavailable).
Use temp_output_dir fixture for output paths.
Mock folder_paths.get_output_directory() where needed.
  </action>
  <verify>
Run `cd /Users/darrindemchuk/code/ai_images/comfyui_batch_image_processing && python -m pytest tests/test_batch_saver.py -v` - all tests pass
  </verify>
  <done>
10+ tests for BatchImageSaver covering format options, filename construction, and overwrite modes. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. All utility functions in save_image_utils.py work correctly
2. BatchImageSaver node follows ComfyUI OUTPUT_NODE pattern
3. All tests pass: `python -m pytest tests/test_save_image_utils.py tests/test_batch_saver.py -v`
4. Node can save images in PNG, JPG, and WebP formats with quality control
</verification>

<success_criteria>
- save_image_utils.py exports: tensor_to_pil, save_with_format, construct_filename, handle_existing_file, resolve_output_directory
- BatchImageSaver class has OUTPUT_NODE = True, RETURN_TYPES = (), save_image method returns {"ui": {"images": [...]}}
- All format options work (PNG, JPG, WebP, Match original)
- All overwrite modes work (Overwrite, Skip, Rename)
- Tests verify all functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-image-saving/02-01-SUMMARY.md`
</output>
